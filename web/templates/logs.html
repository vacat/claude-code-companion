<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .log-body {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .log-body:hover {
            white-space: normal;
            word-break: break-all;
        }
        .save-file-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-top: 0.25rem;
        }
        .content-section {
            position: relative;
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .json-pretty {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        /* æ¨¡å‹é‡å†™ç›¸å…³æ ·å¼ */
        .model-rewritten {
            position: relative;
            display: inline-block;
        }
        .model-rewritten::after {
            content: 'ğŸ”„';
            font-size: 0.7em;
            color: #28a745;
            margin-left: 3px;
        }
        .model-original {
            color: #6c757d;
        }
        /* Tabæ ·å¼ */
        .before-after-tabs {
            margin-bottom: 1rem;
        }
        .before-after-tabs .nav-link {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .comparison-badge {
            font-size: 0.7em;
            vertical-align: super;
            margin-left: 0.25rem;
        }
    </style>
</head>
<body>
    {{template "header.html" .}}

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">è¯·æ±‚æ—¥å¿— (å…± {{.Total}} æ¡){{if .FailedOnly}} - ä»…å¤±è´¥è¯·æ±‚{{end}}</h5>
                        <div>
                            <button class="btn btn-sm {{if .FailedOnly}}btn-warning{{else}}btn-outline-primary{{end}}" onclick="toggleFailedOnly()">
                                <i class="fas fa-filter"></i> {{if .FailedOnly}}æ˜¾ç¤ºå…¨éƒ¨{{else}}ä»…æ˜¾ç¤ºå¤±è´¥{{end}}
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                                <i class="fas fa-refresh"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {{if .FailedOnly}}
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-filter"></i> <strong>ç­›é€‰ä¸­ï¼š</strong> ä»…æ˜¾ç¤ºå¤±è´¥è¯·æ±‚ï¼ˆçŠ¶æ€ç  â‰¥ 400 æˆ–é”™è¯¯ï¼‰
                        </div>
                        {{end}}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>è¯·æ±‚ID</th>
                                        <th>ç«¯ç‚¹</th>
                                        <th>æ¨¡å‹</th>
                                        <th>Tags</th>
                                        <th>çŠ¶æ€</th>
                                        <th>è€—æ—¶</th>
                                        <th>è¯·æ±‚å¤§å°</th>
                                        <th>å“åº”å¤§å°</th>
                                        <th>æµå¼</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .Logs}}
                                    <tr>
                                        <td>{{.Timestamp.Format "15:04:05"}}</td>
                                        <td><small>{{.RequestID}}</small></td>
                                        <td><small>{{.Endpoint}}</small></td>
                                        <td>
                                            <small>
                                                {{if .Model}}
                                                    {{if .ModelRewriteApplied}}
                                                        <span class="model-rewritten" 
                                                              data-bs-toggle="tooltip" 
                                                              data-bs-placement="top" 
                                                              title="â†’ {{.RewrittenModel}}">
                                                            {{.Model}}
                                                        </span>
                                                    {{else}}
                                                        <span class="model-original">{{.Model}}</span>
                                                    {{end}}
                                                {{else}}
                                                    -
                                                {{end}}
                                            </small>
                                        </td>
                                        <td>
                                            {{if .Tags}}
                                                {{range $i, $tag := .Tags}}
                                                    <span class="badge bg-primary me-1">{{$tag}}</span>
                                                {{end}}
                                            {{else}}
                                                <small class="text-muted">-</small>
                                            {{end}}
                                        </td>
                                        <td>
                                            {{if lt .StatusCode 400}}
                                                <span class="badge bg-success">{{.StatusCode}}</span>
                                            {{else}}
                                                <span class="badge bg-danger">{{.StatusCode}}</span>
                                            {{end}}
                                        </td>
                                        <td class="duration-cell" data-ms="{{.DurationMs}}">{{.DurationMs}}ms</td>
                                        <td><small class="filesize-cell" data-bytes="{{.RequestBodySize}}">{{.RequestBodySize}}B</small></td>
                                        <td><small class="filesize-cell" data-bytes="{{.ResponseBodySize}}">{{.ResponseBodySize}}B</small></td>
                                        <td>
                                            {{if .IsStreaming}}
                                                <span class="badge bg-info">SSE</span>
                                                {{if .ContentTypeOverride}}
                                                    <i class="fas fa-sync-alt ms-1" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top" 
                                                       title="Content-Type è¦†ç›–: åŸå§‹ç±»å‹ â†’ {{.ContentTypeOverride}}"
                                                       style="color: #28a745; font-size: 0.7em;"></i>
                                                {{end}}
                                            {{else}}
                                                <span class="badge bg-secondary">JSON</span>
                                                {{if .ContentTypeOverride}}
                                                    <i class="fas fa-sync-alt ms-1" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top" 
                                                       title="Content-Type è¦†ç›–: åŸå§‹ç±»å‹ â†’ {{.ContentTypeOverride}}"
                                                       style="color: #28a745; font-size: 0.7em;"></i>
                                                {{end}}
                                            {{end}}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="showLogDetails('{{.RequestID}}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {{if gt .TotalPages 1}}
                        <nav aria-label="Logs pagination">
                            <ul class="pagination pagination-sm justify-content-center">
                                {{if .HasPrev}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.PrevPage}}&failed_only={{.FailedOnly}}">ä¸Šä¸€é¡µ</a>
                                </li>
                                {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link">ä¸Šä¸€é¡µ</span>
                                </li>
                                {{end}}
                                
                                {{range .Pages}}
                                {{if eq . $.Page}}
                                <li class="page-item active">
                                    <span class="page-link">{{.}}</span>
                                </li>
                                {{else}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.}}&failed_only={{$.FailedOnly}}">{{.}}</a>
                                </li>
                                {{end}}
                                {{end}}
                                
                                {{if .HasNext}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.NextPage}}&failed_only={{.FailedOnly}}">ä¸‹ä¸€é¡µ</a>
                                </li>
                                {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link">ä¸‹ä¸€é¡µ</span>
                                </li>
                                {{end}}
                            </ul>
                        </nav>
                        
                        <div class="text-center text-muted small mt-2">
                            ç¬¬ {{.Page}} / {{.TotalPages}} é¡µï¼Œå…± {{.Total}} æ¡è®°å½•ï¼Œæ¯é¡µæ˜¾ç¤º {{.Limit}} æ¡
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for log details -->
    <div class="modal fade" id="logModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">è¯·æ±‚è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // è·å–å½“å‰çŠ¶æ€
        let failedOnly = {{.FailedOnly}};
        let currentPage = {{.Page}};
        
        function formatDuration(ms) {
            return (ms / 1000).toFixed(3) + 's';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0B';
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
        }
        
        // Format cells after page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Format duration cells
            document.querySelectorAll('.duration-cell').forEach(function(cell) {
                const ms = parseInt(cell.getAttribute('data-ms'));
                cell.textContent = formatDuration(ms);
            });
            
            // Format file size cells
            document.querySelectorAll('.filesize-cell').forEach(function(cell) {
                const bytes = parseInt(cell.getAttribute('data-bytes'));
                cell.textContent = formatFileSize(bytes);
            });
            
            // Initialize Bootstrap tooltips for model rewrite indicators
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
        
        function toggleFailedOnly() {
            failedOnly = !failedOnly;
            window.location.href = `/admin/logs?page=1&failed_only=${failedOnly}`;
        }
        
        function refreshLogs() {
            window.location.href = `/admin/logs?page=${currentPage}&failed_only=${failedOnly}`;
        }

        function showLogDetails(requestId) {
            fetch(`/admin/api/logs?request_id=${requestId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        displayMultipleLogDetails(data.logs);
                    }
                })
                .catch(error => {
                    console.error('Error fetching log details:', error);
                });
        }

        function displayMultipleLogDetails(logs) {
            const modalBody = document.getElementById('modalBody');
            
            if (logs.length === 1) {
                displayLogDetails(logs[0]);
                return;
            }
            
            let html = `<div class="row mb-3">
                <div class="col-12">
                    <h6>è¯·æ±‚è¯¦æƒ… - ${logs.length} æ¬¡å°è¯•</h6>
                    <div class="alert alert-info">
                        <strong>è¯·æ±‚ID:</strong> ${escapeHtml(logs[0].request_id)}<br>
                        <strong>è·¯å¾„:</strong> ${escapeHtml(logs[0].path)}<br>
                        <strong>è¯·æ±‚æ–¹æ³•:</strong> ${escapeHtml(logs[0].method)}<br>
                        <strong>æ€»è€—æ—¶:</strong> ${logs.reduce((sum, log) => sum + log.duration_ms, 0)}ms
                    </div>
                </div>
            </div>`;
            
            logs.forEach((log, index) => {
                html += generateLogAttemptHtml(log, index + 1);
            });
            
            modalBody.innerHTML = html;
            
            // é‡æ–°åˆå§‹åŒ–tooltips for dynamic content
            var tooltipTriggerList = [].slice.call(modalBody.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const modal = new bootstrap.Modal(document.getElementById('logModal'));
            modal.show();
        }

        function generateLogAttemptHtml(log, attemptNum) {
            const isSuccess = log.status_code >= 200 && log.status_code < 300;
            const badgeClass = isSuccess ? 'bg-success' : 'bg-danger';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®è½¬æ¢
            const requestChanges = hasRequestChanges(log);
            const responseChanges = hasResponseChanges(log);
            
            return `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    å°è¯• ${attemptNum}: ${escapeHtml(log.endpoint)} 
                                    <span class="badge ${badgeClass}">${log.status_code}</span>
                                    <span class="badge bg-secondary">${log.duration_ms}ms</span>
                                    ${log.model ? 
                                        (log.model_rewrite_applied ? 
                                            `<span class="badge bg-success model-rewritten" title="â†’ ${escapeHtml(log.rewritten_model)}">${escapeHtml(log.model)}</span>` :
                                            `<span class="badge bg-primary">${escapeHtml(log.model)}</span>`
                                        ) : ''
                                    }
                                    ${log.is_streaming ? '<span class="badge bg-info">SSE</span>' : ''}
                                    ${log.content_type_override ? `<span class="badge bg-warning text-dark" title="Content-Typeè¦†ç›–: ${escapeHtml(log.content_type_override)}">${escapeHtml(log.content_type_override)}</span>` : ''}
                                    ${requestChanges || responseChanges ? '<span class="badge bg-info">æœ‰ä¿®æ”¹</span>' : ''}
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Request/Response Tabs -->
                                <ul class="nav nav-tabs before-after-tabs" id="logTabs${attemptNum}" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="request-tab-${attemptNum}" data-bs-toggle="tab" data-bs-target="#request-${attemptNum}" type="button" role="tab">
                                            è¯·æ±‚æ•°æ® ${requestChanges ? '<span class="comparison-badge badge bg-warning">ä¿®æ”¹</span>' : ''}
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="response-tab-${attemptNum}" data-bs-toggle="tab" data-bs-target="#response-${attemptNum}" type="button" role="tab">
                                            å“åº”æ•°æ® ${responseChanges ? '<span class="comparison-badge badge bg-warning">ä¿®æ”¹</span>' : ''}
                                        </button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content mt-3" id="logTabsContent${attemptNum}">
                                    <!-- Request Tab -->
                                    <div class="tab-pane fade show active" id="request-${attemptNum}" role="tabpanel">
                                        ${generateRequestComparisonHtml(log, attemptNum)}
                                    </div>
                                    
                                    <!-- Response Tab -->  
                                    <div class="tab-pane fade" id="response-${attemptNum}" role="tabpanel">
                                        ${generateResponseComparisonHtml(log, attemptNum)}
                                    </div>
                                </div>
                                
                                ${log.error ? `<div class="row mt-3"><div class="col-12"><div class="alert alert-danger"><strong>é”™è¯¯:</strong> ${escapeHtml(log.error)}</div></div></div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function generateRequestComparisonHtml(log, attemptNum) {
            const hasUrlChanges = log.original_request_url && log.final_request_url && log.original_request_url !== log.final_request_url;
            const hasHeaderChanges = log.original_request_headers && log.final_request_headers && 
                                   JSON.stringify(log.original_request_headers) !== JSON.stringify(log.final_request_headers);
            const hasBodyChanges = log.original_request_body && log.final_request_body && log.original_request_body !== log.final_request_body;
            
            let html = '';
            
            // URLå¯¹æ¯”ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
            if (hasUrlChanges) {
                html += `
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>URL å¯¹æ¯”</h6>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">å®¢æˆ·ç«¯åŸå§‹ URL:</small>
                                    <div class="json-pretty" style="max-height: 100px;">${escapeHtml(log.original_request_url || '-')}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-success">å‘é€ç»™ä¸Šæ¸¸ URL:</small>
                                    <div class="json-pretty" style="max-height: 100px;">${escapeHtml(log.final_request_url || log.original_request_url || '-')}</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Headers å¯¹æ¯”
            html += `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>è¯·æ±‚å¤´å¯¹æ¯” ${hasHeaderChanges ? '<span class="badge bg-warning">æœ‰ä¿®æ”¹</span>' : ''}</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn me-1" 
                                            data-filename="åŸå§‹è¯·æ±‚å¤´_${log.request_id}_å°è¯•${attemptNum}.json"
                                            data-content="${safeBase64Encode(JSON.stringify(log.original_request_headers || {}, null, 2))}"
                                            onclick="saveAsFileFromButton(this)">
                                        <i class="fas fa-download"></i> åŸå§‹
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                            data-filename="æœ€ç»ˆè¯·æ±‚å¤´_${log.request_id}_å°è¯•${attemptNum}.json"
                                            data-content="${safeBase64Encode(JSON.stringify(log.final_request_headers || log.request_headers || {}, null, 2))}"
                                            onclick="saveAsFileFromButton(this)">
                                        <i class="fas fa-download"></i> æœ€ç»ˆ
                                    </button>
                                </div>
                            </div>
                            ${hasHeaderChanges ? `
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">å®¢æˆ·ç«¯åŸå§‹è¯·æ±‚å¤´:</small>
                                        <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.original_request_headers || {}, null, 2)))}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-success">å‘é€ç»™ä¸Šæ¸¸è¯·æ±‚å¤´:</small>
                                        <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.final_request_headers || log.request_headers || {}, null, 2)))}</div>
                                    </div>
                                </div>
                            ` : `
                                <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.request_headers || {}, null, 2)))}</div>
                            `}
                        </div>
                    </div>
                </div>`;
            
            // Body å¯¹æ¯”
            html += `
                <div class="row">
                    <div class="col-12">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>è¯·æ±‚ä½“å¯¹æ¯” (${log.request_body_size} å­—èŠ‚) ${hasBodyChanges ? '<span class="badge bg-warning">æœ‰ä¿®æ”¹</span>' : ''}</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn me-1" 
                                            data-filename="åŸå§‹è¯·æ±‚ä½“_${log.request_id}_å°è¯•${attemptNum}.${getFileExtension(log.original_request_body)}"
                                            data-content="${log.original_request_body ? safeBase64Encode(log.original_request_body) : ''}"
                                            onclick="saveAsFileFromButton(this)" 
                                            ${!log.original_request_body ? 'disabled' : ''}>
                                        <i class="fas fa-download"></i> åŸå§‹
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                            data-filename="æœ€ç»ˆè¯·æ±‚ä½“_${log.request_id}_å°è¯•${attemptNum}.${getFileExtension(log.final_request_body || log.request_body)}"
                                            data-content="${(log.final_request_body || log.request_body) ? safeBase64Encode(log.final_request_body || log.request_body) : ''}"
                                            onclick="saveAsFileFromButton(this)" 
                                            ${!(log.final_request_body || log.request_body) ? 'disabled' : ''}>
                                        <i class="fas fa-download"></i> æœ€ç»ˆ
                                    </button>
                                </div>
                            </div>
                            ${hasBodyChanges ? `
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">å®¢æˆ·ç«¯åŸå§‹è¯·æ±‚ä½“:</small>
                                        <div class="json-pretty" style="max-height: 400px;">
                                            ${log.original_request_body ? escapeHtml(formatJson(log.original_request_body)) : 'æ— è¯·æ±‚ä½“'}
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-success">å‘é€ç»™ä¸Šæ¸¸è¯·æ±‚ä½“:</small>
                                        <div class="json-pretty" style="max-height: 400px;">
                                            ${(log.final_request_body || log.request_body) ? escapeHtml(formatJson(log.final_request_body || log.request_body)) : 'æ— è¯·æ±‚ä½“'}
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="json-pretty" style="max-height: 400px;">
                                    ${log.request_body ? escapeHtml(formatJson(log.request_body)) : 'æ— è¯·æ±‚ä½“'}
                                </div>
                            `}
                        </div>
                    </div>
                </div>`;
            
            return html;
        }

        function generateResponseComparisonHtml(log, attemptNum) {
            const hasHeaderChanges = log.original_response_headers && log.final_response_headers && 
                                   JSON.stringify(log.original_response_headers) !== JSON.stringify(log.final_response_headers);
            const hasBodyChanges = log.original_response_body && log.final_response_body && log.original_response_body !== log.final_response_body;
            
            let html = '';
            
            // Headers å¯¹æ¯”
            html += `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>å“åº”å¤´å¯¹æ¯” ${hasHeaderChanges ? '<span class="badge bg-warning">æœ‰ä¿®æ”¹</span>' : ''}</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn me-1" 
                                            data-filename="åŸå§‹å“åº”å¤´_${log.request_id}_å°è¯•${attemptNum}.json"
                                            data-content="${safeBase64Encode(JSON.stringify(log.original_response_headers || {}, null, 2))}"
                                            onclick="saveAsFileFromButton(this)">
                                        <i class="fas fa-download"></i> åŸå§‹
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                            data-filename="æœ€ç»ˆå“åº”å¤´_${log.request_id}_å°è¯•${attemptNum}.json"
                                            data-content="${safeBase64Encode(JSON.stringify(log.final_response_headers || log.response_headers || {}, null, 2))}"
                                            onclick="saveAsFileFromButton(this)">
                                        <i class="fas fa-download"></i> æœ€ç»ˆ
                                    </button>
                                </div>
                            </div>
                            ${hasHeaderChanges ? `
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">ä¸Šæ¸¸åŸå§‹å“åº”å¤´:</small>
                                        <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.original_response_headers || {}, null, 2)))}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-success">å‘é€ç»™å®¢æˆ·ç«¯å“åº”å¤´:</small>
                                        <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.final_response_headers || log.response_headers || {}, null, 2)))}</div>
                                    </div>
                                </div>
                            ` : `
                                <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.response_headers || {}, null, 2)))}</div>
                            `}
                        </div>
                    </div>
                </div>`;
            
            // Body å¯¹æ¯”
            html += `
                <div class="row">
                    <div class="col-12">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>å“åº”ä½“å¯¹æ¯” (${log.response_body_size} å­—èŠ‚) ${hasBodyChanges ? '<span class="badge bg-warning">æœ‰ä¿®æ”¹</span>' : ''}</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn me-1" 
                                            data-filename="åŸå§‹å“åº”ä½“_${log.request_id}_å°è¯•${attemptNum}.${getFileExtension(log.original_response_body)}"
                                            data-content="${log.original_response_body ? safeBase64Encode(log.original_response_body) : ''}"
                                            onclick="saveAsFileFromButton(this)" 
                                            ${!log.original_response_body ? 'disabled' : ''}>
                                        <i class="fas fa-download"></i> åŸå§‹
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                            data-filename="æœ€ç»ˆå“åº”ä½“_${log.request_id}_å°è¯•${attemptNum}.${getFileExtension(log.final_response_body || log.response_body)}"
                                            data-content="${(log.final_response_body || log.response_body) ? safeBase64Encode(log.final_response_body || log.response_body) : ''}"
                                            onclick="saveAsFileFromButton(this)" 
                                            ${!(log.final_response_body || log.response_body) ? 'disabled' : ''}>
                                        <i class="fas fa-download"></i> æœ€ç»ˆ
                                    </button>
                                </div>
                            </div>
                            ${hasBodyChanges ? `
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">ä¸Šæ¸¸åŸå§‹å“åº”ä½“:</small>
                                        <div class="json-pretty" style="max-height: 400px;">
                                            ${log.original_response_body ? escapeHtml(formatJson(log.original_response_body)) : 'æ— å“åº”ä½“'}
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-success">å‘é€ç»™å®¢æˆ·ç«¯å“åº”ä½“:</small>
                                        <div class="json-pretty" style="max-height: 400px;">
                                            ${(log.final_response_body || log.response_body) ? escapeHtml(formatJson(log.final_response_body || log.response_body)) : 'æ— å“åº”ä½“'}
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="json-pretty" style="max-height: 400px;">
                                    ${log.response_body ? escapeHtml(formatJson(log.response_body)) : 'æ— å“åº”ä½“'}
                                </div>
                            `}
                        </div>
                    </div>
                </div>`;
            
            return html;
        }

        function hasDataChanges(originalUrl, originalHeaders, originalBody, finalUrl, finalHeaders, finalBody) {
            // æ£€æŸ¥URLå˜åŒ–
            if (originalUrl && finalUrl && originalUrl !== finalUrl) return true;
            
            // æ£€æŸ¥headerså˜åŒ–
            if (originalHeaders && finalHeaders) {
                if (JSON.stringify(originalHeaders) !== JSON.stringify(finalHeaders)) return true;
            }
            
            // æ£€æŸ¥bodyå˜åŒ–
            if (originalBody && finalBody && originalBody !== finalBody) return true;
            
            return false;
        }

        function hasRequestChanges(log) {
            const hasUrlChanges = log.original_request_url && log.final_request_url && log.original_request_url !== log.final_request_url;
            const hasHeaderChanges = log.original_request_headers && log.final_request_headers && 
                                   JSON.stringify(log.original_request_headers) !== JSON.stringify(log.final_request_headers);
            const hasBodyChanges = log.original_request_body && log.final_request_body && log.original_request_body !== log.final_request_body;
            
            return hasUrlChanges || hasHeaderChanges || hasBodyChanges;
        }
        
        function hasResponseChanges(log) {
            const hasHeaderChanges = log.original_response_headers && log.final_response_headers && 
                                   JSON.stringify(log.original_response_headers) !== JSON.stringify(log.final_response_headers);
            const hasBodyChanges = log.original_response_body && log.final_response_body && log.original_response_body !== log.final_response_body;
            
            return hasHeaderChanges || hasBodyChanges;
        }

        function displayLogDetails(log) {
            const modalBody = document.getElementById('modalBody');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®è½¬æ¢
            const requestChanges = hasRequestChanges(log);
            const responseChanges = hasResponseChanges(log);

            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6>åŸºæœ¬ä¿¡æ¯</h6>
                        <table class="table table-sm">
                            <tr><th>è¯·æ±‚ID:</th><td>${escapeHtml(log.request_id)}</td></tr>
                            <tr><th>æ—¶é—´æˆ³:</th><td>${new Date(log.timestamp).toLocaleString()}</td></tr>
                            <tr><th>ç«¯ç‚¹:</th><td>${escapeHtml(log.endpoint)}</td></tr>
                            <tr><th>è¯·æ±‚æ–¹æ³•:</th><td>${escapeHtml(log.method)}</td></tr>
                            <tr><th>è·¯å¾„:</th><td>${escapeHtml(log.path)}</td></tr>
                            <tr><th>çŠ¶æ€ç :</th><td>${log.status_code}</td></tr>
                            <tr><th>æ¨¡å‹:</th><td>
                                ${log.model ? 
                                    (log.model_rewrite_applied ? 
                                        `<span class="model-rewritten" title="â†’ ${escapeHtml(log.rewritten_model)}">${escapeHtml(log.model)}</span>` : 
                                        `<span class="model-original">${escapeHtml(log.model)}</span>`
                                    ) : 
                                    '<small class="text-muted">æ— </small>'
                                }
                            </td></tr>
                            <tr><th>è€—æ—¶:</th><td>${log.duration_ms}ms</td></tr>
                            <tr><th>è¯·æ±‚ä½“å¤§å°:</th><td>${log.request_body_size} å­—èŠ‚</td></tr>
                            <tr><th>å“åº”ä½“å¤§å°:</th><td>${log.response_body_size} å­—èŠ‚</td></tr>
                            <tr><th>æµå¼å“åº”:</th><td>${log.is_streaming ? 'æ˜¯ (SSE)' : 'å¦'}</td></tr>
                            <tr><th>Tags:</th><td>${log.tags && log.tags.length > 0 ? log.tags.map(tag => `<span class="badge bg-primary me-1">${escapeHtml(tag)}</span>`).join('') : '<small class="text-muted">æ— </small>'}</td></tr>
                            <tr><th>Content-Typeè¦†ç›–:</th><td>${log.content_type_override ? `<span class="badge bg-warning text-dark">${escapeHtml(log.content_type_override)}</span>` : '<small class="text-muted">æ— </small>'}</td></tr>
                            ${log.error ? `<tr><th>é”™è¯¯:</th><td class="text-danger">${escapeHtml(log.error)}</td></tr>` : ''}
                        </table>
                    </div>
                </div>
                
                <!-- Request/Response Tabs -->
                <ul class="nav nav-tabs before-after-tabs" id="singleLogTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="single-request-tab" data-bs-toggle="tab" data-bs-target="#single-request" type="button" role="tab">
                            è¯·æ±‚æ•°æ® ${requestChanges ? '<span class="comparison-badge badge bg-warning">ä¿®æ”¹</span>' : ''}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="single-response-tab" data-bs-toggle="tab" data-bs-target="#single-response" type="button" role="tab">
                            å“åº”æ•°æ® ${responseChanges ? '<span class="comparison-badge badge bg-warning">ä¿®æ”¹</span>' : ''}
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="singleLogTabsContent">
                    <!-- Request Tab -->
                    <div class="tab-pane fade show active" id="single-request" role="tabpanel">
                        ${generateRequestComparisonHtml(log, 'single')}
                    </div>
                    
                    <!-- Response Tab -->  
                    <div class="tab-pane fade" id="single-response" role="tabpanel">
                        ${generateResponseComparisonHtml(log, 'single')}
                    </div>
                </div>
            `;
            
            // é‡æ–°åˆå§‹åŒ–tooltips for dynamic content
            var tooltipTriggerList = [].slice.call(modalBody.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const modal = new bootstrap.Modal(document.getElementById('logModal'));
            modal.show();
        }

        function formatJson(jsonString) {
            if (!jsonString) return jsonString;
            try {
                const parsed = JSON.parse(jsonString);
                return JSON.stringify(parsed, null, 2);
            } catch {
                return jsonString;
            }
        }

        // UTF-8å®‰å…¨çš„Base64ç¼–ç 
        function safeBase64Encode(str) {
            try {
                // é¦–å…ˆé€šè¿‡encodeURIComponentå¤„ç†UTF-8å­—ç¬¦ï¼Œç„¶åè¿›è¡ŒBase64ç¼–ç 
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            } catch (error) {
                console.warn('Base64ç¼–ç å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•:', error);
                // å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥ä½¿ç”¨encodeURIComponent
                return encodeURIComponent(str);
            }
        }

        // UTF-8å®‰å…¨çš„Base64è§£ç 
        function safeBase64Decode(str) {
            try {
                // é¦–å…ˆå°è¯•æ ‡å‡†Base64è§£ç 
                const decoded = atob(str);
                return decodeURIComponent(Array.prototype.map.call(decoded, function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (error) {
                console.warn('Base64è§£ç å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•:', error);
                // å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥ä½¿ç”¨decodeURIComponent
                try {
                    return decodeURIComponent(str);
                } catch (e) {
                    console.error('æ‰€æœ‰è§£ç æ–¹æ³•éƒ½å¤±è´¥:', e);
                    return str; // è¿”å›åŸå§‹å­—ç¬¦ä¸²
                }
            }
        }
        
        function escapeHtml(text) {
            if (!text) return text;
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // æ ¹æ®å†…å®¹åˆ¤æ–­æ–‡ä»¶æ‰©å±•å
        function getFileExtension(content) {
            if (!content) return 'txt';
            
            try {
                JSON.parse(content);
                return 'json';
            } catch {
                // æ£€æŸ¥æ˜¯å¦æ˜¯SSEæ ¼å¼
                if (content.includes('event: ') && content.includes('data: ')) {
                    return 'sse';
                }
                return 'txt';
            }
        }

        // ä¿å­˜æ–‡ä»¶åŠŸèƒ½ - ä»æŒ‰é’®çš„dataå±æ€§è¯»å–å†…å®¹
        function saveAsFileFromButton(button) {
            const filename = button.getAttribute('data-filename');
            const encodedContent = button.getAttribute('data-content');
            
            if (!encodedContent || encodedContent.trim() === '') {
                alert('å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜');
                return;
            }

            try {
                // ä½¿ç”¨UTF-8å®‰å…¨çš„è§£ç æ–¹æ³•
                const content = safeBase64Decode(encodedContent);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // åˆ›å»ºä¸‹è½½å…ƒç´ 
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = filename;
                downloadLink.style.display = 'none';
                
                // æ·»åŠ åˆ°DOMå¹¶è§¦å‘ä¸‹è½½
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (error) {
                console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
                alert('ä¿å­˜æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°');
            }
        }
    </script>

    {{template "footer.html" .}}
</body>
</html>