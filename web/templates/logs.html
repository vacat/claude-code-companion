<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/shared.css" rel="stylesheet">
</head>
<body>
    {{template "header.html" .}}

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <h5 class="mb-0 me-3" data-t="request_logs_with_count">请求日志 (共 {{.Total}} 条){{if .FailedOnly}} - <span data-t="failed_requests_only">仅失败请求</span>{{end}}</h5>
                            <button class="btn btn-sm btn-outline-danger" onclick="showCleanupModal()">
                                <i class="fas fa-trash"></i> <span data-t="cleanup_logs">清理日志</span>
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-sm {{if .FailedOnly}}btn-warning{{else}}btn-outline-primary{{end}}" onclick="toggleFailedOnly({{if .FailedOnly}}true{{else}}false{{end}}, {{.Page}})">
                                <i class="fas fa-filter"></i> <span data-t="{{if .FailedOnly}}show_all{{else}}show_failed_only{{end}}">{{if .FailedOnly}}显示全部{{else}}仅显示失败{{end}}</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs({{.Page}}, {{if .FailedOnly}}true{{else}}false{{end}})">
                                <i class="fas fa-refresh"></i> <span data-t="refresh">刷新</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {{if .FailedOnly}}
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-filter"></i> <strong data-t="filtering">筛选中：</strong> <span data-t="only_failed_requests_status">仅显示失败请求（状态码 ≥ 400 或错误）</span>
                        </div>
                        {{end}}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th data-t="time">时间</th>
                                        <th data-t="request_id">请求ID</th>
                                        <th data-t="endpoint">端点</th>
                                        <th data-t="model">模型</th>
                                        <th data-t="tags">标签</th>
                                        <th data-t="thinking">思考</th>
                                        <th data-t="status">状态</th>
                                        <th data-t="retry">重试</th>
                                        <th data-t="duration">耗时</th>
                                        <th data-t="request_size">请求大小</th>
                                        <th data-t="response_size">响应大小</th>
                                        <th data-t="streaming">流式</th>
                                        <th data-t="actions">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .Logs}}
                                    <tr>
                                        <td>{{.Timestamp.Format "15:04:05"}}</td>
                                        <td><small>{{.RequestID}}</small></td>
                                        <td class="endpoint-cell" data-endpoint="{{.Endpoint}}">{{.Endpoint}}</td>
                                        <td>
                                            <small>
                                                {{if .Model}}
                                                    {{if .ModelRewriteApplied}}
                                                        <span class="model-rewritten" 
                                                              data-bs-toggle="tooltip" 
                                                              data-bs-placement="top" 
                                                              title="→ {{.RewrittenModel}}">
                                                            {{.Model}}
                                                        </span>
                                                    {{else}}
                                                        <span class="model-original">{{.Model}}</span>
                                                    {{end}}
                                                {{else}}
                                                    -
                                                {{end}}
                                            </small>
                                        </td>
                                        <td>
                                            {{if .Tags}}
                                                {{range $i, $tag := .Tags}}
                                                    <span class="badge bg-primary me-1">{{$tag}}</span>
                                                {{end}}
                                            {{else}}
                                                <small class="text-muted">-</small>
                                            {{end}}
                                        </td>
                                        <td>
                                            {{if .ThinkingEnabled}}
                                                {{if le .ThinkingBudgetTokens 4096}}
                                                    <span class="badge bg-success thinking-badge" 
                                                          data-bs-toggle="tooltip" 
                                                          data-bs-placement="top" 
                                                          title="Low Thinking: {{.ThinkingBudgetTokens}} tokens">T</span>
                                                {{else if le .ThinkingBudgetTokens 16384}}
                                                    <span class="badge bg-warning thinking-badge" 
                                                          data-bs-toggle="tooltip" 
                                                          data-bs-placement="top" 
                                                          title="Medium Thinking: {{.ThinkingBudgetTokens}} tokens">T</span>
                                                {{else if le .ThinkingBudgetTokens 32768}}
                                                    <span class="badge bg-warning text-dark thinking-badge" 
                                                          data-bs-toggle="tooltip" 
                                                          data-bs-placement="top" 
                                                          title="High Thinking: {{.ThinkingBudgetTokens}} tokens">T</span>
                                                {{else}}
                                                    <span class="badge bg-danger thinking-badge" 
                                                          data-bs-toggle="tooltip" 
                                                          data-bs-placement="top" 
                                                          title="Ultra Thinking: {{.ThinkingBudgetTokens}} tokens">T</span>
                                                {{end}}
                                            {{else}}
                                                <small class="text-muted">-</small>
                                            {{end}}
                                        </td>
                                        <td>
                                            {{if and (gt .StatusCode 0) (lt .StatusCode 400)}}
                                                <span class="badge bg-success">{{.StatusCode}}</span>
                                            {{else}}
                                                <span class="badge bg-danger">{{.StatusCode}}</span>
                                            {{end}}
                                        </td>
                                        <td>
                                            {{if .AttemptNumber}}
                                                {{if eq .AttemptNumber 2}}
                                                    <span class="badge bg-warning text-dark">#1</span>
                                                {{else if eq .AttemptNumber 3}}
                                                    <span class="badge bg-warning text-dark">#2</span>
                                                {{else if eq .AttemptNumber 4}}
                                                    <span class="badge bg-warning text-dark">#3</span>
                                                {{else if eq .AttemptNumber 5}}
                                                    <span class="badge bg-warning text-dark">#4</span>
                                                {{else if eq .AttemptNumber 6}}
                                                    <span class="badge bg-warning text-dark">#5</span>
                                                {{else if gt .AttemptNumber 6}}
                                                    <span class="badge bg-warning text-dark">#5+</span>
                                                {{end}}
                                            {{end}}
                                        </td>
                                        <td class="duration-cell" data-ms="{{.DurationMs}}">{{.DurationMs}}ms</td>
                                        <td><small class="filesize-cell" data-bytes="{{.RequestBodySize}}">{{.RequestBodySize}}B</small></td>
                                        <td><small class="filesize-cell" data-bytes="{{.ResponseBodySize}}">{{.ResponseBodySize}}B</small></td>
                                        <td>
                                            {{if .IsStreaming}}
                                                <span class="badge bg-info">SSE</span>
                                                {{if .ContentTypeOverride}}
                                                    <i class="fas fa-sync-alt ms-1" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top" 
                                                       title="Content-Type 覆盖: 原始类型 → {{.ContentTypeOverride}}"
                                                       style="color: #28a745; font-size: 0.7em;"></i>
                                                {{end}}
                                            {{else}}
                                                <span class="badge bg-secondary">JSON</span>
                                                {{if .ContentTypeOverride}}
                                                    <i class="fas fa-sync-alt ms-1" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top" 
                                                       title="Content-Type 覆盖: 原始类型 → {{.ContentTypeOverride}}"
                                                       style="color: #28a745; font-size: 0.7em;"></i>
                                                {{end}}
                                            {{end}}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="showLogDetails('{{.RequestID}}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {{if gt .TotalPages 1}}
                        <nav aria-label="Logs pagination">
                            <ul class="pagination pagination-sm justify-content-center">
                                {{if .HasPrev}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.PrevPage}}&failed_only={{.FailedOnly}}" data-t="previous_page">上一页</a>
                                </li>
                                {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link" data-t="previous_page">上一页</span>
                                </li>
                                {{end}}
                                
                                {{range .Pages}}
                                {{if eq . $.Page}}
                                <li class="page-item active">
                                    <span class="page-link">{{.}}</span>
                                </li>
                                {{else}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.}}&failed_only={{$.FailedOnly}}">{{.}}</a>
                                </li>
                                {{end}}
                                {{end}}
                                
                                {{if .HasNext}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.NextPage}}&failed_only={{.FailedOnly}}" data-t="next_page">下一页</a>
                                </li>
                                {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link" data-t="next_page">下一页</span>
                                </li>
                                {{end}}
                            </ul>
                        </nav>
                        
                        <div class="text-center text-muted small mt-2">
                            <span data-t="pagination_info">第 {{.Page}} / {{.TotalPages}} 页，共 {{.Total}} 条记录，每页显示 {{.Limit}} 条</span>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{template "log-modal.html" .}}

    <!-- 清理日志对话框 -->
    <div class="modal fade" id="cleanupModal" tabindex="-1" aria-labelledby="cleanupModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cleanupModalLabel" data-t="cleanup_logs_title">清理日志</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p data-t="cleanup_logs_warning">请选择要清理的日志范围。此操作不可撤销！</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-t="cleanup_range">清理范围</label>
                        <div class="list-group">
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="cleanupRange" value="1" checked>
                                <span data-t="cleanup_1_day">清除 1 天前的日志</span>
                            </label>
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="cleanupRange" value="7">
                                <span data-t="cleanup_7_days">清除 7 天前的日志</span>
                            </label>
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="cleanupRange" value="30">
                                <span data-t="cleanup_30_days">清除 30 天前的日志</span>
                            </label>
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="cleanupRange" value="0">
                                <span data-t="cleanup_all" class="text-danger">清除所有日志</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-t="cancel">取消</button>
                    <button type="button" class="btn btn-danger" onclick="confirmCleanup()" data-t="confirm_cleanup">确认清理</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/shared.js"></script>
    <script src="/static/logs.js"></script>

    {{template "footer.html" .}}
</body>
</html>