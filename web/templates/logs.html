<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .log-body {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .log-body:hover {
            white-space: normal;
            word-break: break-all;
        }
        .save-file-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-top: 0.25rem;
        }
        .content-section {
            position: relative;
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .json-pretty {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
        }
        /* Ê®°ÂûãÈáçÂÜôÁõ∏ÂÖ≥Ê†∑Âºè */
        .model-rewritten {
            position: relative;
            display: inline-block;
        }
        .model-rewritten::after {
            content: 'üîÑ';
            font-size: 0.7em;
            color: #28a745;
            margin-left: 3px;
        }
        .model-original {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin/">
                <i class="fas fa-server"></i> Claude ‰ª£ÁêÜÁÆ°ÁêÜÂêéÂè∞
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/">ÊéßÂà∂Âè∞</a>
                <a class="nav-link" href="/admin/endpoints">Á´ØÁÇπÈÖçÁΩÆ</a>
                <a class="nav-link" href="/admin/taggers">Taggers</a>
                <a class="nav-link active" href="/admin/logs">ËØ∑Ê±ÇÊó•Âøó</a>
                <a class="nav-link" href="/admin/settings">Á≥ªÁªüËÆæÁΩÆ</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ËØ∑Ê±ÇÊó•Âøó (ÂÖ± {{.Total}} Êù°){{if .FailedOnly}} - ‰ªÖÂ§±Ë¥•ËØ∑Ê±Ç{{end}}</h5>
                        <div>
                            <button class="btn btn-sm {{if .FailedOnly}}btn-warning{{else}}btn-outline-primary{{end}}" onclick="toggleFailedOnly()">
                                <i class="fas fa-filter"></i> {{if .FailedOnly}}ÊòæÁ§∫ÂÖ®ÈÉ®{{else}}‰ªÖÊòæÁ§∫Â§±Ë¥•{{end}}
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                                <i class="fas fa-refresh"></i> Âà∑Êñ∞
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {{if .FailedOnly}}
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-filter"></i> <strong>Á≠õÈÄâ‰∏≠Ôºö</strong> ‰ªÖÊòæÁ§∫Â§±Ë¥•ËØ∑Ê±ÇÔºàÁä∂ÊÄÅÁ†Å ‚â• 400 ÊàñÈîôËØØÔºâ
                        </div>
                        {{end}}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Êó∂Èó¥</th>
                                        <th>ËØ∑Ê±ÇID</th>
                                        <th>Á´ØÁÇπ</th>
                                        <th>Ê®°Âûã</th>
                                        <th>Tags</th>
                                        <th>Áä∂ÊÄÅ</th>
                                        <th>ËÄóÊó∂</th>
                                        <th>ËØ∑Ê±ÇÂ§ßÂ∞è</th>
                                        <th>ÂìçÂ∫îÂ§ßÂ∞è</th>
                                        <th>ÊµÅÂºè</th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .Logs}}
                                    <tr>
                                        <td>{{.Timestamp.Format "15:04:05"}}</td>
                                        <td><small>{{.RequestID}}</small></td>
                                        <td><small>{{.Endpoint}}</small></td>
                                        <td>
                                            <small>
                                                {{if .Model}}
                                                    {{if .ModelRewriteApplied}}
                                                        <span class="model-rewritten" 
                                                              data-bs-toggle="tooltip" 
                                                              data-bs-placement="top" 
                                                              title="‚Üí {{.RewrittenModel}}">
                                                            {{.Model}}
                                                        </span>
                                                    {{else}}
                                                        <span class="model-original">{{.Model}}</span>
                                                    {{end}}
                                                {{else}}
                                                    -
                                                {{end}}
                                            </small>
                                        </td>
                                        <td>
                                            {{if .Tags}}
                                                {{range $i, $tag := .Tags}}
                                                    <span class="badge bg-primary me-1">{{$tag}}</span>
                                                {{end}}
                                            {{else}}
                                                <small class="text-muted">-</small>
                                            {{end}}
                                        </td>
                                        <td>
                                            {{if lt .StatusCode 400}}
                                                <span class="badge bg-success">{{.StatusCode}}</span>
                                            {{else}}
                                                <span class="badge bg-danger">{{.StatusCode}}</span>
                                            {{end}}
                                        </td>
                                        <td class="duration-cell" data-ms="{{.DurationMs}}">{{.DurationMs}}ms</td>
                                        <td><small class="filesize-cell" data-bytes="{{.RequestBodySize}}">{{.RequestBodySize}}B</small></td>
                                        <td><small class="filesize-cell" data-bytes="{{.ResponseBodySize}}">{{.ResponseBodySize}}B</small></td>
                                        <td>
                                            {{if .IsStreaming}}
                                                <span class="badge bg-info">SSE</span>
                                                {{if .ContentTypeOverride}}
                                                    <i class="fas fa-sync-alt ms-1" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top" 
                                                       title="Content-Type Ë¶ÜÁõñ: ÂéüÂßãÁ±ªÂûã ‚Üí {{.ContentTypeOverride}}"
                                                       style="color: #28a745; font-size: 0.7em;"></i>
                                                {{end}}
                                            {{else}}
                                                <span class="badge bg-secondary">JSON</span>
                                                {{if .ContentTypeOverride}}
                                                    <i class="fas fa-sync-alt ms-1" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top" 
                                                       title="Content-Type Ë¶ÜÁõñ: ÂéüÂßãÁ±ªÂûã ‚Üí {{.ContentTypeOverride}}"
                                                       style="color: #28a745; font-size: 0.7em;"></i>
                                                {{end}}
                                            {{end}}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="showLogDetails('{{.RequestID}}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {{if gt .TotalPages 1}}
                        <nav aria-label="Logs pagination">
                            <ul class="pagination pagination-sm justify-content-center">
                                {{if .HasPrev}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.PrevPage}}&failed_only={{.FailedOnly}}">‰∏ä‰∏ÄÈ°µ</a>
                                </li>
                                {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link">‰∏ä‰∏ÄÈ°µ</span>
                                </li>
                                {{end}}
                                
                                {{range .Pages}}
                                {{if eq . $.Page}}
                                <li class="page-item active">
                                    <span class="page-link">{{.}}</span>
                                </li>
                                {{else}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.}}&failed_only={{$.FailedOnly}}">{{.}}</a>
                                </li>
                                {{end}}
                                {{end}}
                                
                                {{if .HasNext}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.NextPage}}&failed_only={{.FailedOnly}}">‰∏ã‰∏ÄÈ°µ</a>
                                </li>
                                {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link">‰∏ã‰∏ÄÈ°µ</span>
                                </li>
                                {{end}}
                            </ul>
                        </nav>
                        
                        <div class="text-center text-muted small mt-2">
                            Á¨¨ {{.Page}} / {{.TotalPages}} È°µÔºåÂÖ± {{.Total}} Êù°ËÆ∞ÂΩïÔºåÊØèÈ°µÊòæÁ§∫ {{.Limit}} Êù°
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for log details -->
    <div class="modal fade" id="logModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ËØ∑Ê±ÇËØ¶ÊÉÖ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Ëé∑ÂèñÂΩìÂâçÁä∂ÊÄÅ
        let failedOnly = {{.FailedOnly}};
        let currentPage = {{.Page}};
        
        function formatDuration(ms) {
            return (ms / 1000).toFixed(3) + 's';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0B';
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
        }
        
        // Format cells after page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Format duration cells
            document.querySelectorAll('.duration-cell').forEach(function(cell) {
                const ms = parseInt(cell.getAttribute('data-ms'));
                cell.textContent = formatDuration(ms);
            });
            
            // Format file size cells
            document.querySelectorAll('.filesize-cell').forEach(function(cell) {
                const bytes = parseInt(cell.getAttribute('data-bytes'));
                cell.textContent = formatFileSize(bytes);
            });
            
            // Initialize Bootstrap tooltips for model rewrite indicators
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
        
        function toggleFailedOnly() {
            failedOnly = !failedOnly;
            window.location.href = `/admin/logs?page=1&failed_only=${failedOnly}`;
        }
        
        function refreshLogs() {
            window.location.href = `/admin/logs?page=${currentPage}&failed_only=${failedOnly}`;
        }

        function showLogDetails(requestId) {
            fetch(`/admin/api/logs?request_id=${requestId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        displayMultipleLogDetails(data.logs);
                    }
                })
                .catch(error => {
                    console.error('Error fetching log details:', error);
                });
        }

        function displayMultipleLogDetails(logs) {
            const modalBody = document.getElementById('modalBody');
            
            if (logs.length === 1) {
                displayLogDetails(logs[0]);
                return;
            }
            
            let html = `<div class="row mb-3">
                <div class="col-12">
                    <h6>ËØ∑Ê±ÇËØ¶ÊÉÖ - ${logs.length} Ê¨°Â∞ùËØï</h6>
                    <div class="alert alert-info">
                        <strong>ËØ∑Ê±ÇID:</strong> ${escapeHtml(logs[0].request_id)}<br>
                        <strong>Ë∑ØÂæÑ:</strong> ${escapeHtml(logs[0].path)}<br>
                        <strong>ËØ∑Ê±ÇÊñπÊ≥ï:</strong> ${escapeHtml(logs[0].method)}<br>
                        <strong>ÊÄªËÄóÊó∂:</strong> ${logs.reduce((sum, log) => sum + log.duration_ms, 0)}ms
                    </div>
                </div>
            </div>`;
            
            logs.forEach((log, index) => {
                const attemptNum = index + 1;
                const isSuccess = log.status_code >= 200 && log.status_code < 300;
                const badgeClass = isSuccess ? 'bg-success' : 'bg-danger';
                
                html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    Â∞ùËØï ${attemptNum}: ${escapeHtml(log.endpoint)} 
                                    <span class="badge ${badgeClass}">${log.status_code}</span>
                                    <span class="badge bg-secondary">${log.duration_ms}ms</span>
                                    ${log.model ? 
                                        (log.model_rewrite_applied ? 
                                            `<span class="badge bg-success model-rewritten" title="‚Üí ${escapeHtml(log.rewritten_model)}">${escapeHtml(log.model)}</span>` :
                                            `<span class="badge bg-primary">${escapeHtml(log.model)}</span>`
                                        ) : ''
                                    }
                                    ${log.is_streaming ? '<span class="badge bg-info">SSE</span>' : ''}
                                    ${log.content_type_override ? `<span class="badge bg-warning text-dark" title="Content-TypeË¶ÜÁõñ: ${escapeHtml(log.content_type_override)}">${escapeHtml(log.content_type_override)}</span>` : ''}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="content-section">
                                            <div class="content-header">
                                                <h6>ËØ∑Ê±ÇÂ§¥</h6>
                                                <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                                        data-filename="ËØ∑Ê±ÇÂ§¥_${log.request_id}_Â∞ùËØï${attemptNum}.json"
                                                        data-content="${safeBase64Encode(JSON.stringify(log.request_headers, null, 2))}"
                                                        onclick="saveAsFileFromButton(this)" 
                                                        ${Object.keys(log.request_headers || {}).length === 0 ? 'disabled' : ''}>
                                                    <i class="fas fa-download"></i> ‰øùÂ≠ò
                                                </button>
                                            </div>
                                            <pre class="json-pretty" style="max-height: 150px;">${JSON.stringify(log.request_headers, null, 2)}</pre>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="content-section">
                                            <div class="content-header">
                                                <h6>ÂìçÂ∫îÂ§¥</h6>
                                                <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                                        data-filename="ÂìçÂ∫îÂ§¥_${log.request_id}_Â∞ùËØï${attemptNum}.json"
                                                        data-content="${safeBase64Encode(JSON.stringify(log.response_headers, null, 2))}"
                                                        onclick="saveAsFileFromButton(this)" 
                                                        ${Object.keys(log.response_headers || {}).length === 0 ? 'disabled' : ''}>
                                                    <i class="fas fa-download"></i> ‰øùÂ≠ò
                                                </button>
                                            </div>
                                            <pre class="json-pretty" style="max-height: 150px;">${JSON.stringify(log.response_headers, null, 2)}</pre>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="content-section">
                                            <div class="content-header">
                                                <h6>ËØ∑Ê±Ç‰Ωì (${log.request_body_size} Â≠óËäÇ)</h6>
                                                <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                                        data-filename="ËØ∑Ê±Ç‰Ωì_${log.request_id}_Â∞ùËØï${attemptNum}.${getFileExtension(log.request_body)}"
                                                        data-content="${log.request_body ? safeBase64Encode(log.request_body) : ''}"
                                                        onclick="saveAsFileFromButton(this)" 
                                                        ${!log.request_body ? 'disabled' : ''}>
                                                    <i class="fas fa-download"></i> ‰øùÂ≠ò
                                                </button>
                                            </div>
                                            <div class="json-pretty" style="max-height: 200px;">
                                                ${log.request_body ? escapeHtml(formatJson(log.request_body)) : 'Êó†ËØ∑Ê±Ç‰Ωì'}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="content-section">
                                            <div class="content-header">
                                                <h6>ÂìçÂ∫î‰Ωì (${log.response_body_size} Â≠óËäÇ)</h6>
                                                <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                                        data-filename="ÂìçÂ∫î‰Ωì_${log.request_id}_Â∞ùËØï${attemptNum}.${getFileExtension(log.response_body)}"
                                                        data-content="${log.response_body ? safeBase64Encode(log.response_body) : ''}"
                                                        onclick="saveAsFileFromButton(this)" 
                                                        ${!log.response_body ? 'disabled' : ''}>
                                                    <i class="fas fa-download"></i> ‰øùÂ≠ò
                                                </button>
                                            </div>
                                            <div class="json-pretty" style="max-height: 200px;">
                                                ${log.response_body ? escapeHtml(formatJson(log.response_body)) : 'Êó†ÂìçÂ∫î‰Ωì'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                ${log.error ? `<div class="row mt-2"><div class="col-12"><div class="alert alert-danger"><strong>ÈîôËØØ:</strong> ${escapeHtml(log.error)}</div></div></div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            
            modalBody.innerHTML = html;
            
            // ÈáçÊñ∞ÂàùÂßãÂåñtooltips for dynamic content
            var tooltipTriggerList = [].slice.call(modalBody.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const modal = new bootstrap.Modal(document.getElementById('logModal'));
            modal.show();
        }

        function displayLogDetails(log) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6>Âü∫Êú¨‰ø°ÊÅØ</h6>
                        <table class="table table-sm">
                            <tr><th>ËØ∑Ê±ÇID:</th><td>${escapeHtml(log.request_id)}</td></tr>
                            <tr><th>Êó∂Èó¥Êà≥:</th><td>${new Date(log.timestamp).toLocaleString()}</td></tr>
                            <tr><th>Á´ØÁÇπ:</th><td>${escapeHtml(log.endpoint)}</td></tr>
                            <tr><th>ËØ∑Ê±ÇÊñπÊ≥ï:</th><td>${escapeHtml(log.method)}</td></tr>
                            <tr><th>Ë∑ØÂæÑ:</th><td>${escapeHtml(log.path)}</td></tr>
                            <tr><th>Áä∂ÊÄÅÁ†Å:</th><td>${log.status_code}</td></tr>
                            <tr><th>Ê®°Âûã:</th><td>
                                ${log.model ? 
                                    (log.model_rewrite_applied ? 
                                        `<span class="model-rewritten" title="‚Üí ${escapeHtml(log.rewritten_model)}">${escapeHtml(log.model)}</span>` : 
                                        `<span class="model-original">${escapeHtml(log.model)}</span>`
                                    ) : 
                                    '<small class="text-muted">Êó†</small>'
                                }
                            </td></tr>
                            <tr><th>ËÄóÊó∂:</th><td>${log.duration_ms}ms</td></tr>
                            <tr><th>ËØ∑Ê±Ç‰ΩìÂ§ßÂ∞è:</th><td>${log.request_body_size} Â≠óËäÇ</td></tr>
                            <tr><th>ÂìçÂ∫î‰ΩìÂ§ßÂ∞è:</th><td>${log.response_body_size} Â≠óËäÇ</td></tr>
                            <tr><th>ÊµÅÂºèÂìçÂ∫î:</th><td>${log.is_streaming ? 'ÊòØ (SSE)' : 'Âê¶'}</td></tr>
                            <tr><th>Tags:</th><td>${log.tags && log.tags.length > 0 ? log.tags.map(tag => `<span class="badge bg-primary me-1">${escapeHtml(tag)}</span>`).join('') : '<small class="text-muted">Êó†</small>'}</td></tr>
                            <tr><th>Content-TypeË¶ÜÁõñ:</th><td>${log.content_type_override ? `<span class="badge bg-warning text-dark">${escapeHtml(log.content_type_override)}</span>` : '<small class="text-muted">Êó†</small>'}</td></tr>
                            ${log.error ? `<tr><th>ÈîôËØØ:</th><td class="text-danger">${escapeHtml(log.error)}</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>ËØ∑Ê±ÇÂ§¥</h6>
                                <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                        data-filename="ËØ∑Ê±ÇÂ§¥_${escapeHtml(log.request_id)}.json"
                                        data-content="${safeBase64Encode(JSON.stringify(log.request_headers, null, 2))}"
                                        onclick="saveAsFileFromButton(this)" 
                                        ${Object.keys(log.request_headers || {}).length === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-download"></i> ‰øùÂ≠ò
                                </button>
                            </div>
                            <pre class="json-pretty">${JSON.stringify(log.request_headers, null, 2)}</pre>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>ÂìçÂ∫îÂ§¥</h6>
                                <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                        data-filename="ÂìçÂ∫îÂ§¥_${escapeHtml(log.request_id)}.json"
                                        data-content="${safeBase64Encode(JSON.stringify(log.response_headers, null, 2))}"
                                        onclick="saveAsFileFromButton(this)" 
                                        ${Object.keys(log.response_headers || {}).length === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-download"></i> ‰øùÂ≠ò
                                </button>
                            </div>
                            <pre class="json-pretty">${JSON.stringify(log.response_headers, null, 2)}</pre>
                        </div>
                    </div>
                    ${log.request_body ? `
                    <div class="col-12 mb-3">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>ËØ∑Ê±Ç‰Ωì</h6>
                                <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                        data-filename="ËØ∑Ê±Ç‰Ωì_${escapeHtml(log.request_id)}.${getFileExtension(log.request_body)}"
                                        data-content="${safeBase64Encode(log.request_body)}"
                                        onclick="saveAsFileFromButton(this)">
                                    <i class="fas fa-download"></i> ‰øùÂ≠ò
                                </button>
                            </div>
                            <pre class="json-pretty">${escapeHtml(formatJson(log.request_body))}</pre>
                        </div>
                    </div>` : ''}
                    ${log.response_body ? `
                    <div class="col-12 mb-3">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>ÂìçÂ∫î‰Ωì</h6>
                                <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                        data-filename="ÂìçÂ∫î‰Ωì_${escapeHtml(log.request_id)}.${getFileExtension(log.response_body)}"
                                        data-content="${safeBase64Encode(log.response_body)}"
                                        onclick="saveAsFileFromButton(this)">
                                    <i class="fas fa-download"></i> ‰øùÂ≠ò
                                </button>
                            </div>
                            <pre class="json-pretty">${escapeHtml(formatJson(log.response_body))}</pre>
                        </div>
                    </div>` : ''}
                </div>
            `;
            
            // ÈáçÊñ∞ÂàùÂßãÂåñtooltips for dynamic content
            var tooltipTriggerList = [].slice.call(modalBody.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const modal = new bootstrap.Modal(document.getElementById('logModal'));
            modal.show();
        }

        function formatJson(jsonString) {
            try {
                const parsed = JSON.parse(jsonString);
                return JSON.stringify(parsed, null, 2);
            } catch {
                return jsonString;
            }
        }

        // UTF-8ÂÆâÂÖ®ÁöÑBase64ÁºñÁ†Å
        function safeBase64Encode(str) {
            try {
                // È¶ñÂÖàÈÄöËøáencodeURIComponentÂ§ÑÁêÜUTF-8Â≠óÁ¨¶ÔºåÁÑ∂ÂêéËøõË°åBase64ÁºñÁ†Å
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            } catch (error) {
                console.warn('Base64ÁºñÁ†ÅÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï:', error);
                // Â§áÁî®ÊñπÊ≥ïÔºöÁõ¥Êé•‰ΩøÁî®encodeURIComponent
                return encodeURIComponent(str);
            }
        }

        // UTF-8ÂÆâÂÖ®ÁöÑBase64Ëß£Á†Å
        function safeBase64Decode(str) {
            try {
                // È¶ñÂÖàÂ∞ùËØïÊ†áÂáÜBase64Ëß£Á†Å
                const decoded = atob(str);
                return decodeURIComponent(Array.prototype.map.call(decoded, function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (error) {
                console.warn('Base64Ëß£Á†ÅÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï:', error);
                // Â§áÁî®ÊñπÊ≥ïÔºöÁõ¥Êé•‰ΩøÁî®decodeURIComponent
                try {
                    return decodeURIComponent(str);
                } catch (e) {
                    console.error('ÊâÄÊúâËß£Á†ÅÊñπÊ≥ïÈÉΩÂ§±Ë¥•:', e);
                    return str; // ËøîÂõûÂéüÂßãÂ≠óÁ¨¶‰∏≤
                }
            }
        }
        
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Ê†πÊçÆÂÜÖÂÆπÂà§Êñ≠Êñá‰ª∂Êâ©Â±ïÂêç
        function getFileExtension(content) {
            if (!content) return 'txt';
            
            try {
                JSON.parse(content);
                return 'json';
            } catch {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØSSEÊ†ºÂºè
                if (content.includes('event: ') && content.includes('data: ')) {
                    return 'sse';
                }
                return 'txt';
            }
        }

        // ‰øùÂ≠òÊñá‰ª∂ÂäüËÉΩ - ‰ªéÊåâÈíÆÁöÑdataÂ±ûÊÄßËØªÂèñÂÜÖÂÆπ
        function saveAsFileFromButton(button) {
            const filename = button.getAttribute('data-filename');
            const encodedContent = button.getAttribute('data-content');
            
            if (!encodedContent || encodedContent.trim() === '') {
                alert('ÂÜÖÂÆπ‰∏∫Á©∫ÔºåÊó†Ê≥ï‰øùÂ≠ò');
                return;
            }

            try {
                // ‰ΩøÁî®UTF-8ÂÆâÂÖ®ÁöÑËß£Á†ÅÊñπÊ≥ï
                const content = safeBase64Decode(encodedContent);
                
                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // ÂàõÂª∫‰∏ãËΩΩÂÖÉÁ¥†
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = filename;
                downloadLink.style.display = 'none';
                
                // Ê∑ªÂä†Âà∞DOMÂπ∂Ëß¶Âèë‰∏ãËΩΩ
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // Ê∏ÖÁêÜ
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (error) {
                console.error('‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•:', error);
                alert('‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÊéßÂà∂Âè∞');
            }
        }

        // ‰øùÂ≠òÊñá‰ª∂ÂäüËÉΩÔºàÊóßÁâàÊú¨Ôºå‰øùÁïôÂÖºÂÆπÊÄßÔºâ
        function saveAsFile(defaultFilename, content) {
            if (!content || content.trim() === '') {
                alert('ÂÜÖÂÆπ‰∏∫Á©∫ÔºåÊó†Ê≥ï‰øùÂ≠ò');
                return;
            }

            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            // ÂàõÂª∫‰∏ãËΩΩÂÖÉÁ¥†
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = defaultFilename;
            downloadLink.style.display = 'none';
            
            // Ê∑ªÂä†Âà∞DOMÂπ∂Ëß¶Âèë‰∏ãËΩΩ
            document.body.appendChild(downloadLink);
            downloadLink.click();
            
            // Ê∏ÖÁêÜ
            setTimeout(() => {
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
            }, 100);
        }
    </script>
</body>
</html>