<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.css" rel="stylesheet">
    <link href="/static/shared.css" rel="stylesheet">
    <style>
        /* å¯¹è¯æ¡†å¸ƒå±€ä¼˜åŒ– */
        .modal-body {
            padding: 1rem 1.5rem;
        }
        
        /* Tab Content Styling - å‡å°‘å†…å®¹é«˜åº¦ */
        .tab-content {
            min-height: 300px;
        }
        
        .tab-pane {
            padding: 0.75rem 0;
        }
        
        /* å‡å°‘è¡¨å•å…ƒç´ é—´è· */
        .tab-pane .mb-3 {
            margin-bottom: 0.75rem !important;
        }
        
        .tab-pane .mb-4 {
            margin-bottom: 1rem !important;
        }
        
        /* Advanced tab section headers */
        .tab-pane h6 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        /* Alert styling in advanced tab */
        .tab-pane .alert {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
        
        /* Tab navigation styling */
        .nav-tabs .nav-link {
            border-bottom: 2px solid transparent;
            color: #6c757d;
        }
        
        .nav-tabs .nav-link.active {
            border-bottom: 2px solid #0d6efd;
            color: #0d6efd;
        }
        
        .nav-tabs .nav-link:hover {
            border-bottom: 2px solid #0d6efd;
            color: #0d6efd;
        }
        
        /* ç¡®ä¿è®¤è¯å€¼è¾“å…¥æ¡†é«˜åº¦ä¸€è‡´ */
        #endpoint-auth-value {
            height: calc(1.5em + 0.75rem + 2px) !important;
            resize: none;
        }
        
        /* è¡¨å•æ ‡ç­¾å›¾æ ‡æ ·å¼ */
        .form-label-icon {
            margin-right: 0.25rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    {{template "header.html" .}}

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">ç«¯ç‚¹é…ç½®</h5>
                            <small class="text-muted">é…ç½®å˜æ›´è‡ªåŠ¨ä¿å­˜ï¼Œå®æ—¶ç”Ÿæ•ˆ</small>
                        </div>
                        <button class="btn btn-primary" onclick="showAddEndpointModal()">
                            <i class="fas fa-plus"></i> æ·»åŠ ç«¯ç‚¹
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- ç‰¹æ®Šç«¯ç‚¹åˆ—è¡¨ -->
                        <div id="special-endpoints-section" class="mb-4" style="display: none;">
                            <h6 class="mb-3">
                                <i class="fas fa-star text-warning"></i> ç‰¹æ®Šç«¯ç‚¹
                                <small class="text-muted ms-2">æœ‰ç‰¹å®šæ ‡ç­¾çš„ç«¯ç‚¹</small>
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th width="40"><i class="fas fa-arrows-alt" title="æ‹–æ‹½è¡Œæ¥é‡æ–°æ’åº"></i></th>
                                            <th>ä¼˜å…ˆçº§</th>
                                            <th>åç§°</th>
                                            <th>URL</th>
                                            <th>ç±»å‹</th>
                                            <th>è·¯å¾„</th>
                                            <th>è®¤è¯æ–¹å¼</th>
                                            <th>ä»£ç†</th>
                                            <th>æ ‡ç­¾</th>
                                            <th>çŠ¶æ€</th>
                                            <th>å¯ç”¨</th>
                                            <th width="160">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="special-endpoint-list">
                                        <!-- ç‰¹æ®Šç«¯ç‚¹å°†è¢«åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- é€šç”¨ç«¯ç‚¹åˆ—è¡¨ -->
                        <div id="general-endpoints-section">
                            <h6 class="mb-3">
                                <i class="fas fa-globe text-info"></i> é€šç”¨ç«¯ç‚¹
                                <small class="text-muted ms-2">æ”¯æŒæ‰€æœ‰è¯·æ±‚ç±»å‹çš„ç«¯ç‚¹</small>
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th width="40"><i class="fas fa-arrows-alt" title="æ‹–æ‹½è¡Œæ¥é‡æ–°æ’åº"></i></th>
                                            <th>ä¼˜å…ˆçº§</th>
                                            <th>åç§°</th>
                                            <th>URL</th>
                                            <th>ç±»å‹</th>
                                            <th>è·¯å¾„</th>
                                            <th>è®¤è¯æ–¹å¼</th>
                                            <th>ä»£ç†</th>
                                            <th>æ ‡ç­¾</th>
                                            <th>çŠ¶æ€</th>
                                            <th>å¯ç”¨</th>
                                            <th width="160">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="general-endpoint-list">
                                        <!-- é€šç”¨ç«¯ç‚¹å°†è¢«åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç«¯ç‚¹æ¨¡æ€æ¡† -->
    <div class="modal fade" id="endpointModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="endpointModalTitle">æ·»åŠ ç«¯ç‚¹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="endpointForm">
                        <input type="hidden" id="endpoint-id" />
                        
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs mb-3" id="endpointModalTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-tab-pane" 
                                        type="button" role="tab" aria-controls="basic-tab-pane" aria-selected="true">
                                    <i class="fas fa-cog"></i> åŸºæœ¬é…ç½®
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-tab-pane" 
                                        type="button" role="tab" aria-controls="advanced-tab-pane" aria-selected="false">
                                    <i class="fas fa-sliders-h"></i> é«˜çº§é…ç½®
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="endpointModalTabContent">
                            <!-- Basic Configuration Tab -->
                            <div class="tab-pane fade show active" id="basic-tab-pane" role="tabpanel" aria-labelledby="basic-tab">
                                <!-- ç¬¬ä¸€è¡Œï¼šåç§°å’Œå¯ç”¨çŠ¶æ€ -->
                                <div class="row mb-3">
                                    <div class="col-9">
                                        <label for="endpoint-name" class="form-label">
                                            <i class="fas fa-tag form-label-icon"></i>åç§° <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="endpoint-name" required>
                                    </div>
                                    <div class="col-3">
                                        <h6 class="mb-2">
                                            <i class="fas fa-power-off form-label-icon"></i> å¯ç”¨
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="endpoint-enabled" checked>
                                            <label class="form-check-label" for="endpoint-enabled">
                                                å¯ç”¨æ­¤ç«¯ç‚¹
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- ç¬¬äºŒè¡Œï¼šURL å’Œ Tags -->
                                <div class="row mb-3">
                                    <div class="col-8">
                                        <label for="endpoint-url" class="form-label">
                                            <i class="fas fa-link form-label-icon"></i>URL <span class="text-danger">*</span>
                                        </label>
                                        <input type="url" class="form-control" id="endpoint-url" required
                                               placeholder="https://api.example.com">
                                    </div>
                                    <div class="col-4">
                                        <label for="endpoint-tags" class="form-label">
                                            <i class="fas fa-tags form-label-icon"></i>æ ‡ç­¾
                                        </label>
                                        <input type="text" class="form-control" id="endpoint-tags" 
                                               placeholder="ç”¨é€—å·åˆ†éš”">
                                        <small class="form-text text-muted">ç•™ç©ºåˆ™ä¸ºä¸‡èƒ½endpoint</small>
                                    </div>
                                </div>

                                <!-- ç¬¬ä¸‰è¡Œï¼šç«¯ç‚¹ç±»å‹å’Œè·¯å¾„å‰ç¼€ -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label for="endpoint-type" class="form-label">
                                            <i class="fas fa-cogs form-label-icon"></i>ç«¯ç‚¹ç±»å‹ <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="endpoint-type" required onchange="onEndpointTypeChange()">
                                            <option value="anthropic">Anthropic (Claude)</option>
                                            <option value="openai">OpenAI Compatible</option>
                                        </select>
                                        <small class="form-text text-muted">é€‰æ‹©ç«¯ç‚¹çš„APIå…¼å®¹ç±»å‹</small>
                                    </div>
                                    <div class="col-6" id="path-prefix-group" style="display: none;">
                                        <label for="endpoint-path-prefix" class="form-label">
                                            <i class="fas fa-route form-label-icon"></i>è·¯å¾„å‰ç¼€ <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="endpoint-path-prefix" 
                                               placeholder="/v1/chat/completions">
                                        <small class="form-text text-muted">OpenAIå…¼å®¹ç«¯ç‚¹çš„APIè·¯å¾„</small>
                                    </div>
                                </div>

                                <!-- ç¬¬å››è¡Œï¼šè®¤è¯æ–¹å¼å’Œè®¤è¯å€¼ -->
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <label for="endpoint-auth-type" class="form-label">
                                            <i class="fas fa-key form-label-icon"></i>è®¤è¯æ–¹å¼ <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="endpoint-auth-type" required onchange="onAuthTypeChange()">
                                            <option value="api_key">API Key (x-api-key è¯·æ±‚å¤´)</option>
                                            <option value="auth_token" selected>Auth Token (Authorization Bearer)</option>
                                        </select>
                                    </div>
                                    <div class="col-8">
                                        <label for="endpoint-auth-value" class="form-label">
                                            <i class="fas fa-shield-alt form-label-icon"></i>è®¤è¯å€¼ <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="endpoint-auth-value" required
                                                   placeholder="è¾“å…¥æ‚¨çš„ API Key æˆ– Token">
                                            <button class="btn btn-outline-secondary" type="button" id="toggle-auth-visibility" onclick="toggleAuthVisibility()">
                                                <i class="fas fa-eye" id="auth-eye-icon"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Configuration Tab -->
                            <div class="tab-pane fade" id="advanced-tab-pane" role="tabpanel" aria-labelledby="advanced-tab">
                                <!-- ä»£ç†é…ç½®åŒºåŸŸ -->
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">
                                            <i class="fas fa-shield-alt"></i> ä»£ç†é…ç½®
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="proxy-enabled">
                                            <label class="form-check-label" for="proxy-enabled">å¯ç”¨ä»£ç†</label>
                                        </div>
                                    </div>
                                    
                                    <div id="proxy-config" style="display: none;">
                                        <small class="form-text text-muted mb-3 d-block">é…ç½®HTTPæˆ–SOCKS5ä»£ç†ä»¥è®¿é—®ä¸Šæ¸¸ç«¯ç‚¹</small>
                                        
                                        <!-- ä»£ç†ç±»å‹å’Œåœ°å€ -->
                                        <div class="row mb-3">
                                            <div class="col-4">
                                                <label for="proxy-type" class="form-label">ä»£ç†ç±»å‹</label>
                                                <select class="form-select" id="proxy-type">
                                                    <option value="http">HTTP</option>
                                                    <option value="socks5">SOCKS5</option>
                                                </select>
                                            </div>
                                            <div class="col-8">
                                                <label for="proxy-address" class="form-label">ä»£ç†åœ°å€</label>
                                                <input type="text" class="form-control" id="proxy-address" 
                                                       placeholder="127.0.0.1:1080">
                                                <small class="form-text text-muted">æ ¼å¼: ä¸»æœº:ç«¯å£</small>
                                            </div>
                                        </div>
                                        
                                        <!-- ä»£ç†è®¤è¯ -->
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label for="proxy-username" class="form-label">ç”¨æˆ·å (å¯é€‰)</label>
                                                <input type="text" class="form-control" id="proxy-username" 
                                                       placeholder="ä»£ç†è®¤è¯ç”¨æˆ·å">
                                            </div>
                                            <div class="col-6">
                                                <label for="proxy-password" class="form-label">å¯†ç  (å¯é€‰)</label>
                                                <input type="password" class="form-control" id="proxy-password" 
                                                       placeholder="ä»£ç†è®¤è¯å¯†ç ">
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info p-2">
                                            <small class="text-muted">
                                                <strong>è¯´æ˜ï¼š</strong><br>
                                                â€¢ ç•™ç©ºç”¨æˆ·åå’Œå¯†ç è¡¨ç¤ºæ— éœ€è®¤è¯<br>
                                                â€¢ HTTPä»£ç†æ”¯æŒ CONNECT æ–¹æ³•ç”¨äºHTTPS<br>
                                                â€¢ SOCKS5ä»£ç†æ”¯æŒTCPè¿æ¥ä»£ç†
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- æ¨¡å‹é‡å†™é…ç½®åŒºåŸŸ -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">
                                            <i class="fas fa-exchange-alt"></i> æ¨¡å‹é‡å†™é…ç½®
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="model-rewrite-enabled">
                                            <label class="form-check-label" for="model-rewrite-enabled">å¯ç”¨æ¨¡å‹é‡å†™</label>
                                        </div>
                                    </div>
                                    
                                    <div id="model-rewrite-rules" style="display: none;">
                                        <small class="form-text text-muted mb-3 d-block">é…ç½®è§„åˆ™å°†åŒ¹é…çš„Claudeæ¨¡å‹é‡å†™ä¸ºå…¶ä»–æ¨¡å‹</small>
                                        
                                        <div id="rewrite-rules-list">
                                            <!-- åŠ¨æ€ç”Ÿæˆçš„è§„åˆ™åˆ—è¡¨ -->
                                        </div>
                                        
                                        <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addRewriteRule()">
                                            <i class="fas fa-plus"></i> æ·»åŠ è§„åˆ™
                                        </button>
                                        
                                        <div class="alert alert-info p-2">
                                            <small class="text-muted">
                                                <strong>é¢„è®¾æ¨¡å‹æ¨¡å¼ï¼š</strong><br>
                                                â€¢ Haikuç³»åˆ—: claude-*haiku*<br>
                                                â€¢ Sonnetç³»åˆ—: claude-*sonnet*<br>  
                                                â€¢ Opusç³»åˆ—: claude-*opus*<br>
                                                â€¢ æ‰€æœ‰Claude: claude-*
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveEndpoint()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="/static/shared.js"></script>
    <script>
        let currentEndpoints = [];
        let editingEndpointName = null;
        let endpointModal = null;
        let originalAuthValue = '';  // ä¿å­˜åŸå§‹auth value
        let isAuthVisible = false;   // auth valueæ˜¯å¦å¯è§

        document.addEventListener('DOMContentLoaded', function() {
            initializeCommonFeatures();
            endpointModal = new bootstrap.Modal(document.getElementById('endpointModal'));
            loadEndpoints();
            
            // Auto-refresh every 30 seconds (only status updates)
            setInterval(refreshEndpointStatus, 30000);
        });

        let specialSortableInstance = null;
        let generalSortableInstance = null;

        function initializeSortable() {
            // é”€æ¯ç°æœ‰çš„sortableå®ä¾‹
            if (specialSortableInstance) {
                specialSortableInstance.destroy();
                specialSortableInstance = null;
            }
            if (generalSortableInstance) {
                generalSortableInstance.destroy();
                generalSortableInstance = null;
            }

            // åˆå§‹åŒ–ç‰¹æ®Šç«¯ç‚¹åˆ—è¡¨çš„æ‹–æ‹½æ’åº
            const specialTbody = document.getElementById('special-endpoint-list');
            if (specialTbody && specialTbody.children.length > 0) {
                specialSortableInstance = new Sortable(specialTbody, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    group: 'special-endpoints', // é™åˆ¶åœ¨ç‰¹æ®Šç«¯ç‚¹ç»„å†…æ‹–æ‹½
                    onStart: function(evt) {
                        document.body.style.cursor = 'grabbing';
                    },
                    onEnd: function (evt) {
                        document.body.style.cursor = '';
                        reorderEndpoints();
                    }
                });
            }
            
            // åˆå§‹åŒ–é€šç”¨ç«¯ç‚¹åˆ—è¡¨çš„æ‹–æ‹½æ’åº
            const generalTbody = document.getElementById('general-endpoint-list');
            if (generalTbody && generalTbody.children.length > 0) {
                generalSortableInstance = new Sortable(generalTbody, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    group: 'general-endpoints', // é™åˆ¶åœ¨é€šç”¨ç«¯ç‚¹ç»„å†…æ‹–æ‹½
                    onStart: function(evt) {
                        document.body.style.cursor = 'grabbing';
                    },
                    onEnd: function (evt) {
                        document.body.style.cursor = '';
                        reorderEndpoints();
                    }
                });
            }
        }

        function loadEndpoints() {
            fetch('/admin/api/endpoints')
                .then(response => response.json())
                .then(data => {
                    currentEndpoints = data.endpoints;
                    rebuildTable(currentEndpoints);
                })
                .catch(error => {
                    console.error('Failed to load endpoints:', error);
                    showAlert('Failed to load endpoints', 'danger');
                });
        }

        function refreshEndpointStatus() {
            fetch('/admin/api/endpoints')
                .then(response => response.json())
                .then(data => {
                    // Only update status and statistics, not the full table
                    data.endpoints.forEach(endpoint => {
                        // å°è¯•åœ¨ç‰¹æ®Šç«¯ç‚¹åˆ—è¡¨ä¸­æŸ¥æ‰¾
                        let row = document.querySelector(`#special-endpoint-list tr[data-endpoint-name="${endpoint.name}"]`);
                        if (!row) {
                            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ™åœ¨é€šç”¨ç«¯ç‚¹åˆ—è¡¨ä¸­æŸ¥æ‰¾
                            row = document.querySelector(`#general-endpoint-list tr[data-endpoint-name="${endpoint.name}"]`);
                        }
                        if (row) {
                            updateEndpointRowStatus(row, endpoint);
                        }
                    });
                })
                .catch(error => console.error('Failed to refresh endpoint status:', error));
        }

        function updateEndpointRowStatus(row, endpoint) {
            const statusCell = row.children[9]; // è°ƒæ•´ç´¢å¼•ï¼šå¢åŠ äº†ä»£ç†åˆ—ï¼ŒåŸæ¥æ˜¯8ï¼Œç°åœ¨æ˜¯9
            
            // Update status
            let statusBadge = '';
            if (endpoint.status === 'active') {
                statusBadge = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> æ´»è·ƒ</span>';
            } else if (endpoint.status === 'inactive') {
                statusBadge = '<span class="badge bg-danger"><i class="fas fa-times-circle"></i> ä¸å¯ç”¨</span>';
            } else {
                statusBadge = '<span class="badge bg-warning"><i class="fas fa-clock"></i> æ£€æµ‹ä¸­</span>';
            }
            statusCell.innerHTML = statusBadge;
        }

        function refreshTable() {
            // é‡æ–°åŠ è½½ç«¯ç‚¹æ•°æ®è€Œä¸æ˜¯åˆ·æ–°æ•´ä¸ªé¡µé¢
            loadEndpoints();
        }

        // æå–åŸŸåï¼Œåªæ˜¾ç¤ºåŸŸåéƒ¨åˆ†ï¼Œè·¯å¾„ç”¨...çœç•¥  
        function extractDomain(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname;
            } catch (e) {
                return url; // å¦‚æœä¸æ˜¯æœ‰æ•ˆURLï¼Œè¿”å›åŸå§‹å†…å®¹
            }
        }
        
        // æˆªæ–­è·¯å¾„ï¼Œè¶…è¿‡æŒ‡å®šé•¿åº¦ç”¨...æ˜¾ç¤º
        function truncatePath(path, maxLength = 10) {
            if (!path || path.length <= maxLength) {
                return path;
            }
            return path.substring(0, maxLength) + '...';
        }

        function rebuildTable(endpoints) {
            const specialTbody = document.getElementById('special-endpoint-list');
            const generalTbody = document.getElementById('general-endpoint-list');
            const specialSection = document.getElementById('special-endpoints-section');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            specialTbody.innerHTML = '';
            generalTbody.innerHTML = '';
            
            // åˆ†ç¦»æœ‰æ ‡ç­¾å’Œæ— æ ‡ç­¾çš„ç«¯ç‚¹
            const specialEndpoints = endpoints.filter(endpoint => endpoint.tags && endpoint.tags.length > 0);
            const generalEndpoints = endpoints.filter(endpoint => !endpoint.tags || endpoint.tags.length === 0);
            
            // æ˜¾ç¤º/éšè—ç‰¹æ®Šç«¯ç‚¹åŒºåŸŸ
            if (specialEndpoints.length > 0) {
                specialSection.style.display = 'block';
            } else {
                specialSection.style.display = 'none';
            }
            
            // åˆ›å»ºç«¯ç‚¹è¡Œçš„å‡½æ•°
            function createEndpointRow(endpoint, index) {
                const row = document.createElement('tr');
                row.className = 'endpoint-row';
                row.setAttribute('data-endpoint-name', endpoint.name);
                
                // æ„å»ºçŠ¶æ€å¾½ç« 
                let statusBadge = '';
                if (endpoint.status === 'active') {
                    statusBadge = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> æ´»è·ƒ</span>';
                } else if (endpoint.status === 'inactive') {
                    statusBadge = '<span class="badge bg-danger"><i class="fas fa-times-circle"></i> ä¸å¯ç”¨</span>';
                } else {
                    statusBadge = '<span class="badge bg-warning"><i class="fas fa-clock"></i> æ£€æµ‹ä¸­</span>';
                }
                
                // æ„å»ºå¯ç”¨çŠ¶æ€å¾½ç« 
                const enabledBadge = endpoint.enabled 
                    ? '<span class="badge bg-success"><i class="fas fa-toggle-on"></i> å·²å¯ç”¨</span>'
                    : '<span class="badge bg-secondary"><i class="fas fa-toggle-off"></i> å·²ç¦ç”¨</span>';
                
                // æ„å»ºç«¯ç‚¹ç±»å‹å¾½ç« 
                const endpointTypeBadge = endpoint.endpoint_type === 'openai' 
                    ? '<span class="badge bg-warning">openai</span>'
                    : '<span class="badge bg-primary">anthropic</span>';
                
                // æ„å»º URL æ˜¾ç¤ºï¼šåªæ˜¾ç¤ºåŸŸåï¼Œå®Œæ•´ URL åœ¨ title ä¸­æ˜¾ç¤º 
                const domainOnly = extractDomain(endpoint.url);
                const urlDisplay = `<code class="url-display" title="${endpoint.url}">${domainOnly}</code>`;
                
                // æ„å»ºè·¯å¾„æ˜¾ç¤ºï¼šè¶…è¿‡10ä¸ªå­—ç¬¦æˆªæ–­
                let pathDisplay;
                if (endpoint.endpoint_type === 'openai') {
                    const fullPath = endpoint.path_prefix || '';
                    const truncatedPath = truncatePath(fullPath, 10);
                    pathDisplay = `<code class="path-display" title="${fullPath}">${truncatedPath}</code>`;
                } else {
                    pathDisplay = '<span class="text-muted">/v1/messages</span>';
                }
                
                // æ„å»ºè®¤è¯ç±»å‹å¾½ç« 
                const authTypeBadge = endpoint.auth_type === 'api_key' 
                    ? '<span class="badge bg-primary">api_key</span>'
                    : '<span class="badge bg-secondary">auth_token</span>';
                
                // æ„å»ºä»£ç†çŠ¶æ€æ˜¾ç¤º
                let proxyDisplay = '';
                if (endpoint.proxy && endpoint.proxy.type && endpoint.proxy.address) {
                    const proxyType = endpoint.proxy.type.toUpperCase();
                    const hasAuth = endpoint.proxy.username ? ' ğŸ”' : '';
                    proxyDisplay = `<span class="badge bg-warning" title="ä»£ç†: ${endpoint.proxy.type}://${endpoint.proxy.address}">${proxyType}${hasAuth}</span>`;
                } else {
                    proxyDisplay = '<span class="text-muted">æ— </span>';
                }
                
                // æ„å»ºtagsæ˜¾ç¤º
                let tagsDisplay = '';
                if (endpoint.tags && endpoint.tags.length > 0) {
                    tagsDisplay = endpoint.tags.map(tag => `<span class="badge bg-info me-1 mb-1">${tag}</span>`).join('');
                } else {
                    tagsDisplay = '<span class="text-muted">é€šç”¨</span>';
                }
                
                row.innerHTML = `
                    <td class="drag-handle text-center">
                        <i class="fas fa-arrows-alt text-muted"></i>
                    </td>
                    <td>
                        <span class="badge bg-info priority-badge">${endpoint.priority}</span>
                    </td>
                    <td><strong>${endpoint.name}</strong></td>
                    <td>${urlDisplay}</td>
                    <td>${endpointTypeBadge}</td>
                    <td>${pathDisplay}</td>
                    <td>${authTypeBadge}</td>
                    <td>${proxyDisplay}</td>
                    <td>${tagsDisplay}</td>
                    <td>${statusBadge}</td>
                    <td>${enabledBadge}</td>
                    <td class="action-buttons">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary btn-sm" 
                                    onclick="event.stopPropagation(); showEditEndpointModal('${endpoint.name}')"
                                    title="ç¼–è¾‘">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info btn-sm" 
                                    onclick="event.stopPropagation(); copyEndpoint('${endpoint.name}')"
                                    title="å¤åˆ¶">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" 
                                    onclick="event.stopPropagation(); deleteEndpoint('${endpoint.name}')"
                                    title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                return row;
            }
            
            // æ·»åŠ ç‰¹æ®Šç«¯ç‚¹
            specialEndpoints.forEach((endpoint, index) => {
                const row = createEndpointRow(endpoint, index);
                specialTbody.appendChild(row);
            });
            
            // æ·»åŠ é€šç”¨ç«¯ç‚¹
            generalEndpoints.forEach((endpoint, index) => {
                const row = createEndpointRow(endpoint, specialEndpoints.length + index);
                generalTbody.appendChild(row);
            });
            
            // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½æ’åº
            initializeSortable();
        }

        function showAddEndpointModal() {
            editingEndpointName = null;
            originalAuthValue = '';
            isAuthVisible = false;
            
            document.getElementById('endpointModalTitle').textContent = 'æ·»åŠ ç«¯ç‚¹';
            document.getElementById('endpointForm').reset();
            document.getElementById('endpoint-enabled').checked = true;
            document.getElementById('endpoint-type').value = 'anthropic'; // é»˜è®¤ä¸º Anthropic
            document.getElementById('endpoint-tags').value = ''; // æ¸…ç†tagså­—æ®µ
            
            // è®¾ç½®ç«¯ç‚¹ç±»å‹å¹¶åˆ‡æ¢è·¯å¾„å‰ç¼€æ˜¾ç¤º
            onEndpointTypeChange();
            
            // é‡ç½®auth visibility
            resetAuthVisibility();
            
            // æ¸…ç©ºä»£ç†é…ç½®
            loadProxyConfig(null);
            
            // æ¸…ç©ºæ¨¡å‹é‡å†™é…ç½®
            loadModelRewriteConfig(null);
            
            // é‡ç½®åˆ°åŸºæœ¬é…ç½®tab
            resetModalTabs();
            
            endpointModal.show();
        }

        function showEditEndpointModal(endpointName) {
            const endpoint = currentEndpoints.find(ep => ep.name === endpointName);
            if (!endpoint) {
                showAlert('ç«¯ç‚¹æœªæ‰¾åˆ°', 'danger');
                return;
            }

            editingEndpointName = endpointName;
            originalAuthValue = endpoint.auth_value;
            isAuthVisible = false;
            
            document.getElementById('endpointModalTitle').textContent = 'ç¼–è¾‘ç«¯ç‚¹';
            
            // Populate form
            document.getElementById('endpoint-name').value = endpoint.name;
            document.getElementById('endpoint-url').value = endpoint.url;
            document.getElementById('endpoint-type').value = endpoint.endpoint_type || 'anthropic';
            document.getElementById('endpoint-path-prefix').value = endpoint.path_prefix || '';
            document.getElementById('endpoint-auth-type').value = endpoint.auth_type;
            document.getElementById('endpoint-enabled').checked = endpoint.enabled;
            
            // è®¾ç½®ç«¯ç‚¹ç±»å‹å¹¶åˆ‡æ¢è·¯å¾„å‰ç¼€æ˜¾ç¤º
            onEndpointTypeChange();
            
            // è®¾ç½®tagså­—æ®µ
            const tagsValue = endpoint.tags && endpoint.tags.length > 0 ? endpoint.tags.join(', ') : '';
            document.getElementById('endpoint-tags').value = tagsValue;
            
            // è®¾ç½®auth valueä¸ºæ˜Ÿå·
            document.getElementById('endpoint-auth-value').value = '*'.repeat(Math.min(endpoint.auth_value.length, 50));
            document.getElementById('endpoint-auth-value').type = 'password'; // ç¡®ä¿æ˜¯passwordç±»å‹
            document.getElementById('endpoint-auth-value').placeholder = 'è¾“å…¥æ‚¨çš„ API Key æˆ– Token';
            resetAuthVisibility();
            
            // åŠ è½½ä»£ç†é…ç½®
            loadProxyConfig(endpoint.proxy);
            
            // åŠ è½½æ¨¡å‹é‡å†™é…ç½®
            loadModelRewriteConfig(endpoint.model_rewrite);
            
            // é‡ç½®åˆ°åŸºæœ¬é…ç½®tab
            resetModalTabs();
            
            endpointModal.show();
        }

        // é‡ç½®æ¨¡æ€æ¡†tabsåˆ°åŸºæœ¬é…ç½®
        function resetModalTabs() {
            // é‡ç½®tabçŠ¶æ€
            const basicTab = document.getElementById('basic-tab');
            const advancedTab = document.getElementById('advanced-tab');
            const basicPane = document.getElementById('basic-tab-pane');
            const advancedPane = document.getElementById('advanced-tab-pane');
            
            // æ¿€æ´»åŸºæœ¬é…ç½®tab
            basicTab.classList.add('active');
            basicTab.setAttribute('aria-selected', 'true');
            basicPane.classList.add('show', 'active');
            
            // å»æ¿€æ´»é«˜çº§é…ç½®tab
            advancedTab.classList.remove('active');
            advancedTab.setAttribute('aria-selected', 'false');
            advancedPane.classList.remove('show', 'active');
        }

        function toggleAuthVisibility() {
            const authValueField = document.getElementById('endpoint-auth-value');
            const eyeIcon = document.getElementById('auth-eye-icon');
            
            if (isAuthVisible) {
                // éšè—ï¼šæ˜¾ç¤ºæ˜Ÿå·
                if (originalAuthValue) {
                    authValueField.value = '*'.repeat(Math.min(originalAuthValue.length, 50));
                }
                authValueField.type = 'password'; // è®¾ç½®ä¸ºpasswordç±»å‹
                eyeIcon.className = 'fas fa-eye';
                isAuthVisible = false;
            } else {
                // æ˜¾ç¤ºï¼šæ˜¾ç¤ºçœŸå®å€¼
                authValueField.value = originalAuthValue;
                authValueField.type = 'text'; // è®¾ç½®ä¸ºtextç±»å‹
                eyeIcon.className = 'fas fa-eye-slash';
                isAuthVisible = true;
            }
        }

        function resetAuthVisibility() {
            const eyeIcon = document.getElementById('auth-eye-icon');
            eyeIcon.className = 'fas fa-eye';
            isAuthVisible = false;
        }

        function saveEndpoint() {
            const form = document.getElementById('endpointForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // è·å–auth valueçš„çœŸå®å€¼
            let authValue = document.getElementById('endpoint-auth-value').value;
            if (!isAuthVisible && originalAuthValue && authValue.startsWith('*')) {
                // å¦‚æœæ˜¾ç¤ºçš„æ˜¯æ˜Ÿå·ä¸”æœ‰åŸå§‹å€¼ï¼Œä½¿ç”¨åŸå§‹å€¼
                authValue = originalAuthValue;
            }

            // è§£ætagså­—æ®µ
            const tagsInput = document.getElementById('endpoint-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            const data = {
                name: document.getElementById('endpoint-name').value,
                url: document.getElementById('endpoint-url').value,
                endpoint_type: document.getElementById('endpoint-type').value,
                path_prefix: document.getElementById('endpoint-path-prefix').value || '', // PathPrefix å¯ä»¥ä¸ºç©º
                auth_type: document.getElementById('endpoint-auth-type').value,
                auth_value: authValue,
                enabled: document.getElementById('endpoint-enabled').checked,
                tags: tags,
                proxy: collectProxyData() // æ–°å¢ï¼šæ”¶é›†ä»£ç†é…ç½®
            };

            const isEditing = editingEndpointName !== null;
            const url = isEditing 
                ? `/admin/api/endpoints/${encodeURIComponent(editingEndpointName)}` 
                : '/admin/api/endpoints';
            const method = isEditing ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    // ä¿å­˜æˆåŠŸåï¼Œå¦‚æœæœ‰æ¨¡å‹é‡å†™é…ç½®ï¼Œä¹Ÿä¿å­˜å®ƒ
                    const modelRewriteConfig = collectModelRewriteData();
                    const endpointName = document.getElementById('endpoint-name').value;
                    
                    const saveModelRewrite = modelRewriteConfig 
                        ? saveModelRewriteConfig(endpointName, modelRewriteConfig)
                        : Promise.resolve();
                    
                    saveModelRewrite
                        .then(() => {
                            endpointModal.hide();
                            showAlert(data.message, 'success');
                            loadEndpoints(); // é‡æ–°åŠ è½½æ•°æ®è€Œä¸æ˜¯åˆ·æ–°é¡µé¢
                        })
                        .catch(error => {
                            console.error('Failed to save model rewrite config:', error);
                            showAlert('ç«¯ç‚¹ä¿å­˜æˆåŠŸï¼Œä½†æ¨¡å‹é‡å†™é…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'warning');
                            endpointModal.hide();
                            loadEndpoints();
                        });
                }
            })
            .catch(error => {
                console.error('Failed to save endpoint:', error);
                showAlert('Failed to save endpoint', 'danger');
            });
        }

        function deleteEndpoint(endpointName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç«¯ç‚¹ "${endpointName}" å—ï¼Ÿ`)) {
                return;
            }

            fetch(`/admin/api/endpoints/${encodeURIComponent(endpointName)}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert(data.message, 'success');
                    loadEndpoints(); // é‡æ–°åŠ è½½æ•°æ®è€Œä¸æ˜¯åˆ·æ–°é¡µé¢
                }
            })
            .catch(error => {
                console.error('Failed to delete endpoint:', error);
                showAlert('Failed to delete endpoint', 'danger');
            });
        }

        function copyEndpoint(endpointName) {
            if (!confirm(`ç¡®å®šè¦å¤åˆ¶ç«¯ç‚¹ "${endpointName}" å—ï¼Ÿ`)) {
                return;
            }

            fetch(`/admin/api/endpoints/${encodeURIComponent(endpointName)}/copy`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert(data.message, 'success');
                    loadEndpoints(); // é‡æ–°åŠ è½½æ•°æ®ä»¥æ˜¾ç¤ºæ–°å¤åˆ¶çš„ç«¯ç‚¹
                }
            })
            .catch(error => {
                console.error('Failed to copy endpoint:', error);
                showAlert('Failed to copy endpoint', 'danger');
            });
        }

        function reorderEndpoints() {
            // è·å–ç‰¹æ®Šç«¯ç‚¹çš„é¡ºåº
            const specialRows = document.querySelectorAll('#special-endpoint-list tr');
            const specialOrderedNames = Array.from(specialRows).map(row => row.dataset.endpointName);
            
            // è·å–é€šç”¨ç«¯ç‚¹çš„é¡ºåº
            const generalRows = document.querySelectorAll('#general-endpoint-list tr');
            const generalOrderedNames = Array.from(generalRows).map(row => row.dataset.endpointName);
            
            // åˆå¹¶é¡ºåºï¼šç‰¹æ®Šç«¯ç‚¹åœ¨å‰ï¼Œé€šç”¨ç«¯ç‚¹åœ¨å
            const orderedNames = [...specialOrderedNames, ...generalOrderedNames];
            
            fetch('/admin/api/endpoints/reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ordered_names: orderedNames
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                    loadEndpoints(); // é‡æ–°åŠ è½½ä»¥æ¢å¤é¡ºåº
                } else {
                    showAlert(data.message, 'success');
                    // æ›´æ–°ä¼˜å…ˆçº§æ˜¾ç¤ºï¼Œä¸éœ€è¦é‡æ–°åŠ è½½æ•´ä¸ªè¡¨æ ¼
                    let priorityIndex = 1;
                    
                    // æ›´æ–°ç‰¹æ®Šç«¯ç‚¹çš„ä¼˜å…ˆçº§
                    specialRows.forEach((row) => {
                        const priorityBadge = row.querySelector('.priority-badge');
                        if (priorityBadge) {
                            priorityBadge.textContent = priorityIndex++;
                        }
                    });
                    
                    // æ›´æ–°é€šç”¨ç«¯ç‚¹çš„ä¼˜å…ˆçº§
                    generalRows.forEach((row) => {
                        const priorityBadge = row.querySelector('.priority-badge');
                        if (priorityBadge) {
                            priorityBadge.textContent = priorityIndex++;
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Failed to reorder endpoints:', error);
                showAlert('Failed to reorder endpoints', 'danger');
                loadEndpoints(); // é‡æ–°åŠ è½½ä»¥æ¢å¤é¡ºåº
            });
        }

        // ===== Endpoint Type and Auth Type Functions =====
        
        function onEndpointTypeChange() {
            togglePathPrefixField();
            toggleAuthTypeForEndpointType();
        }
        
        function togglePathPrefixField() {
            const endpointType = document.getElementById('endpoint-type').value;
            const pathPrefixGroup = document.getElementById('path-prefix-group');
            const pathPrefixInput = document.getElementById('endpoint-path-prefix');
            
            if (endpointType === 'openai') {
                pathPrefixGroup.style.display = 'block';
                pathPrefixInput.required = true;
                if (!pathPrefixInput.value) {
                    pathPrefixInput.value = '/v1/chat/completions'; // é»˜è®¤å€¼
                }
            } else {
                pathPrefixGroup.style.display = 'none';
                pathPrefixInput.required = false;
                pathPrefixInput.value = ''; // æ¸…ç©ºå€¼
            }
        }
        
        function toggleAuthTypeForEndpointType() {
            const endpointType = document.getElementById('endpoint-type').value;
            const authTypeSelect = document.getElementById('endpoint-auth-type');
            
            if (endpointType === 'openai') {
                // OpenAI compatible endpoints use auth_token and cannot be changed
                authTypeSelect.value = 'auth_token';
                authTypeSelect.disabled = true;
            } else {
                // Anthropic endpoints can use either auth type, but default to auth_token
                authTypeSelect.disabled = false;
                if (!editingEndpointName) { // Only set default for new endpoints
                    authTypeSelect.value = 'auth_token';
                }
            }
        }
        
        function onAuthTypeChange() {
            // This function can be used for future auth type specific logic
            // Currently no additional logic needed
        }

        // ===== Modal Functions =====

        // ä»£ç†é…ç½®å¯ç”¨/ç¦ç”¨åˆ‡æ¢
        document.getElementById('proxy-enabled').addEventListener('change', function() {
            const proxyConfigDiv = document.getElementById('proxy-config');
            proxyConfigDiv.style.display = this.checked ? 'block' : 'none';
        });

        // æ¨¡å‹é‡å†™å¯ç”¨/ç¦ç”¨åˆ‡æ¢
        document.getElementById('model-rewrite-enabled').addEventListener('change', function() {
            const rulesDiv = document.getElementById('model-rewrite-rules');
            rulesDiv.style.display = this.checked ? 'block' : 'none';
        });

        // æ·»åŠ é‡å†™è§„åˆ™
        function addRewriteRule(sourcePattern = '', targetModel = '') {
            const rulesList = document.getElementById('rewrite-rules-list');
            const ruleIndex = rulesList.children.length;
            
            const ruleDiv = document.createElement('div');
            ruleDiv.className = 'row mb-2 rewrite-rule';
            ruleDiv.innerHTML = `
                <div class="col-5">
                    <select class="form-select source-model-select" onchange="updateSourcePattern(${ruleIndex})">
                        <option value="">é€‰æ‹©é¢„è®¾æ¨¡å‹</option>
                        <option value="claude-*haiku*">Haiku ç³»åˆ—</option>
                        <option value="claude-*sonnet*">Sonnet ç³»åˆ—</option>
                        <option value="claude-*opus*">Opus ç³»åˆ—</option>
                        <option value="claude-*">æ‰€æœ‰ Claude</option>
                        <option value="custom">è‡ªå®šä¹‰é€šé…ç¬¦</option>
                    </select>
                    <input type="text" class="form-control mt-1 source-pattern-input" 
                           placeholder="é€šé…ç¬¦æ¨¡å¼" value="${sourcePattern}" readonly>
                </div>
                <div class="col-5">
                    <input type="text" class="form-control target-model-input" 
                           placeholder="ç›®æ ‡æ¨¡å‹ (å¦‚: deepseek-chat)" value="${targetModel}">
                    <small class="text-muted">æ¨è: deepseek-chat</small>
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRewriteRule(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm mt-1" onclick="testRewriteRule(${ruleIndex})" title="æµ‹è¯•è§„åˆ™">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
            `;
            
            rulesList.appendChild(ruleDiv);
        }

        // æ›´æ–°æºæ¨¡å¼è¾“å…¥æ¡†
        function updateSourcePattern(ruleIndex) {
            const ruleDiv = document.querySelectorAll('.rewrite-rule')[ruleIndex];
            const select = ruleDiv.querySelector('.source-model-select');
            const input = ruleDiv.querySelector('.source-pattern-input');
            
            if (select.value === 'custom') {
                input.readOnly = false;
                input.focus();
            } else {
                input.readOnly = true;
                input.value = select.value;
            }
        }

        // ç§»é™¤é‡å†™è§„åˆ™
        function removeRewriteRule(button) {
            button.closest('.rewrite-rule').remove();
        }

        // æµ‹è¯•é‡å†™è§„åˆ™
        function testRewriteRule(ruleIndex) {
            const testModel = prompt('è¯·è¾“å…¥è¦æµ‹è¯•çš„æ¨¡å‹åç§°:', 'claude-3-haiku-20240307');
            if (!testModel) return;

            if (!editingEndpointName) {
                alert('è¯·å…ˆä¿å­˜ç«¯ç‚¹åå†æµ‹è¯•è§„åˆ™');
                return;
            }

            fetch(`/admin/api/endpoints/${encodeURIComponent(editingEndpointName)}/test-model-rewrite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ test_model: testModel })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`æµ‹è¯•å¤±è´¥: ${data.error}`);
                } else {
                    const message = data.rewrite_applied 
                        ? `âœ… é‡å†™ç”Ÿæ•ˆ!\nåŸæ¨¡å‹: ${data.original_model}\né‡å†™ä¸º: ${data.rewritten_model}\nåŒ¹é…è§„åˆ™: ${data.matched_rule}`
                        : `âŒ æ— é‡å†™\næ¨¡å‹: ${data.original_model}\næœªåŒ¹é…ä»»ä½•è§„åˆ™`;
                    alert(message);
                }
            })
            .catch(error => {
                console.error('Test failed:', error);
                alert('æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }

        // æ”¶é›†ä»£ç†é…ç½®æ•°æ®
        function collectProxyData() {
            const enabled = document.getElementById('proxy-enabled').checked;
            if (!enabled) {
                return null;
            }

            const type = document.getElementById('proxy-type').value;
            const address = document.getElementById('proxy-address').value.trim();
            const username = document.getElementById('proxy-username').value.trim();
            const password = document.getElementById('proxy-password').value.trim();
            
            if (!address) {
                return null; // åœ°å€ä¸ºç©ºæ—¶ä¸ä¿å­˜ä»£ç†é…ç½®
            }

            const proxyConfig = {
                type: type,
                address: address
            };

            // åªæœ‰å½“ç”¨æˆ·åå’Œå¯†ç éƒ½ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ è®¤è¯ä¿¡æ¯
            if (username && password) {
                proxyConfig.username = username;
                proxyConfig.password = password;
            }

            return proxyConfig;
        }

        // åŠ è½½ä»£ç†é…ç½®åˆ°è¡¨å•
        function loadProxyConfig(config) {
            const checkbox = document.getElementById('proxy-enabled');
            const configDiv = document.getElementById('proxy-config');
            
            if (config) {
                checkbox.checked = true;
                configDiv.style.display = 'block';
                
                document.getElementById('proxy-type').value = config.type || 'http';
                document.getElementById('proxy-address').value = config.address || '';
                document.getElementById('proxy-username').value = config.username || '';
                document.getElementById('proxy-password').value = config.password || '';
            } else {
                checkbox.checked = false;
                configDiv.style.display = 'none';
                
                // é‡ç½®è¡¨å•å­—æ®µ
                document.getElementById('proxy-type').value = 'http';
                document.getElementById('proxy-address').value = '';
                document.getElementById('proxy-username').value = '';
                document.getElementById('proxy-password').value = '';
            }
        }

        // æ”¶é›†æ¨¡å‹é‡å†™é…ç½®æ•°æ®
        function collectModelRewriteData() {
            const enabled = document.getElementById('model-rewrite-enabled').checked;
            if (!enabled) {
                return null;
            }

            const rules = [];
            document.querySelectorAll('.rewrite-rule').forEach(ruleDiv => {
                const sourcePattern = ruleDiv.querySelector('.source-pattern-input').value.trim();
                const targetModel = ruleDiv.querySelector('.target-model-input').value.trim();
                
                if (sourcePattern && targetModel) {
                    rules.push({
                        source_pattern: sourcePattern,
                        target_model: targetModel
                    });
                }
            });

            return rules.length > 0 ? { enabled: true, rules: rules } : null;
        }

        // åŠ è½½æ¨¡å‹é‡å†™é…ç½®åˆ°è¡¨å•
        function loadModelRewriteConfig(config) {
            const checkbox = document.getElementById('model-rewrite-enabled');
            const rulesDiv = document.getElementById('model-rewrite-rules');
            const rulesList = document.getElementById('rewrite-rules-list');
            
            // æ¸…ç©ºç°æœ‰è§„åˆ™
            rulesList.innerHTML = '';
            
            if (config && config.enabled && config.rules) {
                checkbox.checked = true;
                rulesDiv.style.display = 'block';
                
                config.rules.forEach(rule => {
                    addRewriteRule(rule.source_pattern, rule.target_model);
                });
            } else {
                checkbox.checked = false;
                rulesDiv.style.display = 'none';
            }
        }

        // ä¿å­˜æ¨¡å‹é‡å†™é…ç½®
        function saveModelRewriteConfig(endpointName, config) {
            if (!config) return Promise.resolve();

            return fetch(`/admin/api/endpoints/${encodeURIComponent(endpointName)}/model-rewrite`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                return data;
            });
        }
    </script>

    {{template "footer.html" .}}
</body>
</html>